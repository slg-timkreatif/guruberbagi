<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Guru Berbagi - Selogiri</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" href="https://img.icons8.com/fluency/96/student-center.png">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { primary: '#0d9488' }
                }
            }
        }
    </script>

    <style>
        /* === SYSTEM CORE === */
        body { background-color: #f8fafc; color: #1e293b; transition: 0.3s; }
        html.dark body { background-color: #0f172a !important; color: white !important; }

        /* === COMPONENT: FILTER BAR === */
        .filter-bar {
            background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 8px; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        html.dark .filter-bar { background-color: #1e293b; border-color: #334155; }

        /* === COMPONENT: BUTTONS === */
        .btn-contrast {
            background-color: #0f172a; color: #ffffff; border: none;
            padding: 8px 20px; border-radius: 99px; font-weight: 800; font-size: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .btn-contrast:active { transform: scale(0.95); }
        html.dark .btn-contrast { background-color: #ffffff !important; color: #0f172a !important; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        .btn-source {
            background-color: #ffffff; border: 1px solid #cbd5e1; color: #64748b;
            padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 700; transition: all 0.2s;
        }
        .btn-source.active {
            background-color: #0d9488 !important; color: #ffffff !important; border-color: #0d9488 !important;
        }
        html.dark .btn-source { background: #1e293b; border-color: #334155; color: #94a3b8; }
        html.dark .btn-source.active { background: #0d9488 !important; color: white !important; }

        .btn-filter {
            background: transparent; border: 1px solid transparent; color: #1e293b;
            padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 12px; outline: none; transition: 0.2s;
        }
        .btn-filter:hover { background-color: #f1f5f9; }
        html.dark .btn-filter { color: white !important; }
        html.dark .btn-filter:hover { background-color: #334155; }

        /* === COMPONENT: CARDS === */
        .custom-card {
            background-color: #ffffff; color: #1e293b; border: 1px solid #e2e8f0;
            border-radius: 1rem; overflow: hidden; display: flex; transition: 0.3s;
        }
        html.dark .custom-card, html.dark .dashboard-card {
            background-color: #1e293b !important; color: #f8fafc !important; border-color: #334155 !important;
        }
        
        /* Responsive Card Layout */
        @media (max-width: 768px) {
            .custom-card { flex-direction: row; height: 110px; }
            .card-thumb { width: 110px; height: 100%; flex-shrink: 0; }
            .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
            .desktop-only { display: none !important; }
        }
        @media (min-width: 769px) {
            .custom-card { flex-direction: column; height: 100%; }
            .card-thumb { width: 100%; height: 180px; }
            .card-body { padding: 16px; flex: 1; display: flex; flex-direction: column; }
            .mobile-only { display: none !important; }
        }

        /* === UTILS & FORMS === */
        .glass-nav { background: rgba(255,255,255,0.95); border-bottom: 1px solid #e2e8f0; }
        html.dark .glass-nav { background: #0f172a; border-bottom: 1px solid #334155; }
        .form-control, .form-select { background-color: #ffffff; border: 1px solid #cbd5e1; color: #0f172a; border-radius: 10px; }
        html.dark .form-control, html.dark .form-select { background-color: #1e293b !important; border-color: #334155 !important; color: white !important; }
        html.dark option { background-color: #0f172a; color: white; }
        .modal-content { border-radius: 1.5rem; border: none; }
        html.dark .modal-content { background: #1e293b; color: white; border: 1px solid #334155; }
        html.dark .btn-close { filter: invert(1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fab { position: fixed; bottom: 30px; right: 30px; z-index: 50; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="fixed top-0 w-full z-50 glass-nav h-20 flex items-center shadow-sm">
        <div class="max-w-7xl w-full mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="switchView('GALERI')">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-teal-500 to-emerald-500 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition">
                    <i data-lucide="screen-share" class="w-5 h-5"></i>
                </div>
                <div class="leading-none">
                    <div class="font-bold text-lg text-slate-800 dark:text-white">GURU BERBAGI</div>
                    <div class="text-[10px] font-bold tracking-widest text-teal-600 dark:text-teal-400 uppercase mt-0.5">SELOGIRI</div>
                </div>
            </div>
            <div class="hidden md:block flex-1 max-w-md mx-8 relative">
                <input type="text" id="deskSearchInput" oninput="runFilter()" placeholder="Cari karya..." class="btn-filter w-full pl-12 text-sm !text-left border !border-slate-300 dark:!border-slate-600 focus:ring-2 focus:ring-teal-500">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 opacity-50"></i>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                    <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                </button>
                <button id="authBtn" onclick="handleAuth()" class="hidden md:block px-6 py-2 bg-teal-800 text-white rounded-full text-xs font-bold shadow-lg">LOGIN</button>
                <button class="md:hidden w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center" data-bs-toggle="offcanvas" data-bs-target="#sideMenu"><i data-lucide="menu" class="w-5 h-5 dark:text-white"></i></button>
            </div>
        </div>
    </nav>

    <main class="pt-28 pb-24 px-4 md:px-8 max-w-7xl mx-auto">
        <div id="view-galeri">
            <div class="hidden md:block text-center mb-10">
                <h1 class="text-5xl font-extrabold mb-3 text-slate-900 dark:text-white tracking-tight">Selamat Datang, <span class="text-teal-600 dark:text-teal-400">Pendidik Hebat!</span> üëã</h1>
                <p class="text-lg text-slate-600 dark:text-slate-300">Temukan ratusan media pembelajaran kreatif karya guru terbaik Kecamatan Selogiri.</p>
            </div>
            
            <div class="md:hidden mb-6 relative">
                <input type="text" id="mobSearchInput" oninput="runFilter()" placeholder="Cari judul..." class="btn-filter w-full pl-12 py-3 !rounded-2xl shadow-sm border !border-slate-200 dark:!border-slate-700 text-left">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50"></i>
            </div>
            
            <div class="hidden md:flex justify-between items-center mb-8">
                <div class="filter-bar">
                    <button onclick="filterSemua()" class="btn-contrast hover:scale-105 transition">Semua</button>
                    <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                    <select id="filterMapel" onchange="runFilter()" class="btn-filter cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700"><option value="">Semua Mapel</option></select>
                    <select id="filterFase" onchange="runFilter()" class="btn-filter cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700"><option value="">Semua Fase</option></select>
                </div>
                <button id="btnFavDesk" onclick="filterSimpanan()" class="px-6 py-2.5 border border-red-500 text-red-500 rounded-full text-xs font-bold hover:bg-red-500 hover:text-white flex items-center gap-2 transition group">
                    <i data-lucide="heart" class="w-3 h-3 group-hover:fill-current"></i> Favorit
                </button>
            </div>
            
            <div id="galeri-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6"></div>
            
            <div id="loader" class="text-center py-20"><div class="spinner-border text-teal-600" role="status"></div><p class="text-xs mt-3 opacity-60 font-bold">Sedang memuat data...</p></div>
            <div id="emptyState" class="hidden text-center py-20 opacity-60 flex flex-col items-center"><div class="p-4 bg-slate-200 dark:bg-slate-800 rounded-full mb-3"><i data-lucide="search-x" class="w-8 h-8"></i></div><p>Tidak ada karya ditemukan.</p></div>
            <div id="loadMoreContainer" class="hidden text-center mt-12"><button onclick="loadMoreItems()" class="px-8 py-3 border border-slate-300 dark:border-slate-600 rounded-full font-bold text-sm hover:opacity-80 transition shadow-sm text-slate-700 dark:text-white">Muat Lebih Banyak</button></div>
        </div>

        <div id="view-dashboard" class="hidden fade-in">
            <div class="dashboard-card bg-white p-8 rounded-[2rem] border border-slate-200 shadow-xl relative overflow-hidden flex flex-col items-center text-center mb-8">
                <button onclick="switchView('GALERI')" class="absolute top-6 left-6 p-2 rounded-full bg-slate-100 dark:bg-white/10 hover:bg-slate-200 z-20"><i data-lucide="arrow-left" class="w-5 h-5 dark:text-white"></i></button>
                <div class="mt-16 md:mt-0 w-24 h-24 rounded-full bg-gradient-to-tr from-teal-500 to-emerald-500 p-1 flex-shrink-0 relative z-10 shadow-lg">
                    <div class="w-full h-full rounded-full bg-white dark:bg-slate-900 flex items-center justify-center text-3xl font-bold text-teal-700 dark:text-teal-400" id="dashAv">U</div>
                </div>
                <div class="mt-4 z-10">
                    <h2 class="text-3xl font-bold mb-1 text-slate-900 dark:text-white" id="dashName">Nama User</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-4" id="dashSchool">Nama Sekolah</p>
                    <div id="lvlBadgeContainer" class="mb-4"></div>
                </div>
                <div class="mt-2 flex flex-col md:flex-row gap-3 w-full md:w-auto z-10 justify-center">
                    <button onclick="openCardModal()" class="px-8 py-2.5 bg-teal-600 text-white rounded-full font-bold shadow hover:bg-teal-700 transition flex items-center justify-center gap-2 w-full md:w-auto"><i data-lucide="id-card" class="w-4 h-4"></i> Cetak Kartu</button>
                    <button onclick="logout()" class="px-8 py-2.5 border border-red-500 text-red-500 rounded-full font-bold hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2 w-full md:w-auto"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                </div>
                <div class="absolute top-0 right-0 w-64 h-64 bg-teal-500/5 rounded-bl-full pointer-events-none"></div>
                <div class="absolute top-0 left-0 w-32 h-32 bg-purple-500/5 rounded-br-full pointer-events-none"></div>
            </div>
            
            <div class="flex items-center justify-between mb-6 pl-4 border-l-4 border-teal-500"><h3 class="font-bold text-xl text-slate-800 dark:text-white">Karya Saya</h3><button onclick="clickFab()" class="text-sm font-bold text-teal-600 hover:underline flex items-center gap-1"><i data-lucide="plus-circle" class="w-4 h-4"></i> Upload Baru</button></div>
            <div id="dash-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </main>

    <button id="btnAdd" onclick="clickFab()" class="hidden fab w-14 h-14 bg-teal-600 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 hover:bg-teal-700 transition"><i data-lucide="plus" class="w-8 h-8"></i></button>

    <div class="offcanvas offcanvas-end !bg-slate-900 !text-white border-0" tabindex="-1" id="sideMenu">
        <div class="offcanvas-header border-b border-white/10"><h5 class="font-bold">Menu</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
        <div class="offcanvas-body p-6 space-y-4">
            <div id="menuUser" class="hidden p-4 bg-white/10 rounded-2xl flex items-center gap-3">
                <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center font-bold" id="menuAv">U</div><div class="font-bold text-sm truncate" id="menuName">User</div>
            </div>
            <button onclick="closeMenu(); switchView('GALERI')" class="w-full text-left py-3 border-b border-white/10 flex items-center gap-3 hover:text-teal-400"><i data-lucide="home" class="w-5 h-5"></i> Beranda</button>
            <button onclick="closeMenu(); filterSimpanan()" class="w-full text-left py-3 border-b border-white/10 flex items-center gap-3 hover:text-red-400"><i data-lucide="heart" class="w-5 h-5"></i> Favorit Saya</button>
            <div id="menuGuruItems" class="hidden space-y-1">
                <button onclick="closeMenu(); switchView('DASHBOARD')" class="w-full text-left py-3 border-b border-white/10 flex items-center gap-3 text-teal-400"><i data-lucide="user" class="w-5 h-5"></i> Dashboard</button>
                <button onclick="closeMenu(); clickFab()" class="w-full text-left py-3 border-b border-white/10 flex items-center gap-3 text-yellow-400"><i data-lucide="upload-cloud" class="w-5 h-5"></i> Upload Karya</button>
                <button onclick="closeMenu(); logout()" class="w-full text-left py-3 text-red-500 font-bold mt-4 flex items-center gap-3"><i data-lucide="log-out" class="w-5 h-5"></i> Keluar</button>
            </div>
            <div id="menuGuest"><button onclick="closeMenu(); loginModal()" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold mt-4 shadow-lg">Login Guru</button></div>
        </div>
    </div>

    <div class="modal fade" id="modalInput" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header border-b border-slate-100 dark:border-slate-700"><h5 class="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><i data-lucide="edit-3"></i> Editor</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-6"><form id="modalForm" class="grid lg:grid-cols-2 gap-6"><input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editRowIdx"><div class="space-y-4"><div><label class="text-xs font-bold opacity-60 block mb-1">JUDUL</label><input id="inJudul" class="form-control font-bold" placeholder="Judul karya..."></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold opacity-60 block mb-1">MAPEL</label><select id="inMapel" class="form-select" onchange="checkOther('inMapel','manMapel',this.value)"></select><input id="manMapel" class="form-control mt-2 hidden" placeholder="Tulis Mapel..."></div><div><label class="text-xs font-bold opacity-60 block mb-1">JENIS</label><select id="inJenis" class="form-select" onchange="checkOther('inJenis','manJenis',this.value)"></select><input id="manJenis" class="form-control mt-2 hidden" placeholder="Tulis Jenis..."></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold opacity-60 block mb-1">FASE</label><select id="inFase" class="form-select"></select></div><div><label class="text-xs font-bold opacity-60 block mb-1">SEMESTER</label><select id="inSem" class="form-select"></select></div></div><div class="space-y-2"><label class="text-xs font-bold opacity-60">SUMBER KONTEN</label><div class="flex gap-2"><button type="button" onclick="setSource('LINK')" class="btn-source" id="btnSrcLink">LINK</button><button type="button" onclick="setSource('STORY')" class="btn-source" id="btnSrcStory">STORY</button><button type="button" onclick="setSource('HTML')" class="btn-source" id="btnSrcHtml">EMBED</button></div><input type="hidden" id="inputSourceType" value="LINK"><div id="groupLink"><input type="url" id="inLink" class="form-control" placeholder="Link Drive/YouTube..." oninput="updateLivePreview()"></div><div id="groupStory" class="hidden"><input type="url" id="inLinkStory" class="form-control !border-teal-500" placeholder="Link Story..." oninput="updateLivePreview()"></div><div id="groupHtml" class="hidden"><textarea id="inHtml" class="form-control font-mono text-xs" rows="3" placeholder="Kode Embed <iframe>..." oninput="updateLivePreview()"></textarea></div></div><div class="p-3 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-between border border-slate-200 dark:border-slate-700"><div><div class="text-sm font-bold">KAIH</div><div class="text-[10px] opacity-60">Program Kebiasaan Anak</div></div><div class="flex items-center gap-2"><div id="kaihBox" class="hidden"><select id="inKaihType" class="form-select form-select-sm !py-1 !text-xs"></select></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkKaih" onchange="toggleKaih(this.checked)"></div></div></div></div><div class="bg-slate-100 dark:bg-black/30 rounded-xl overflow-hidden flex items-center justify-center min-h-[250px] border border-slate-200 dark:border-slate-700"><iframe id="miniPreviewFrame" class="w-full h-full border-0"></iframe></div></form></div><div class="modal-footer border-t border-slate-100 dark:border-slate-700"><button class="btn btn-link text-slate-500 dark:text-slate-400 no-underline" data-bs-dismiss="modal">Batal</button><button onclick="prosesSimpan()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 border-0 shadow">SIMPAN</button></div></div></div></div>

    <div class="modal fade" id="modalCetakKartu" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content !bg-transparent border-0 shadow-none"><div class="modal-body p-0 text-center"><div id="cardArea" class="w-[320px] h-[500px] mx-auto bg-slate-900 rounded-[2rem] overflow-hidden relative text-left text-white shadow-2xl"><div class="absolute top-[-50px] right-[-50px] w-40 h-40 bg-white/10 rounded-full blur-2xl"></div><div class="absolute bottom-[-20px] left-[-20px] w-32 h-32 bg-teal-500/20 rounded-full blur-xl"></div><div class="p-6 flex flex-col h-full relative z-10"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-teal-600"><i data-lucide="screen-share" class="w-5 h-5"></i></div><div class="leading-none"><div class="font-bold text-xs tracking-widest">GURU BERBAGI</div><div class="text-[8px] opacity-70">SELOGIRI CREATOR</div></div></div></div><div class="flex-1 flex flex-col items-center justify-center text-center"><div class="w-24 h-24 rounded-full p-1 bg-gradient-to-tr from-teal-500 to-emerald-500 mb-4 shadow-lg"><div class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center text-4xl font-bold" id="cardAvatar">U</div></div><h2 class="text-xl font-bold mb-1 line-clamp-1 px-2" id="cardName">Nama</h2><p class="text-xs opacity-60 mb-4 px-4 line-clamp-1" id="cardSchool">Sekolah</p><div class="grid grid-cols-2 gap-3 w-full px-2"><div class="bg-white/5 rounded-xl p-2 border border-white/5"><div class="text-lg font-bold" id="cardKaryaCount">0</div><div class="text-[8px] uppercase tracking-wider opacity-60">Karya</div></div><div class="bg-white/5 rounded-xl p-2 border border-white/5"><div class="text-lg font-bold" id="cardViewCount">0</div><div class="text-[8px] uppercase tracking-wider opacity-60">Views</div></div></div></div><div class="mt-auto pt-6 flex justify-between items-end border-t border-white/10"><div class="text-[8px] opacity-50 max-w-[150px]">"Terus berkarya dan menginspirasi untuk pendidikan Indonesia."</div><div class="bg-white p-1 rounded-lg"><img src="https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=GURU_BERBAGI_SELOGIRI" class="w-10 h-10"></div></div></div></div><button onclick="downloadCard()" class="mt-6 px-8 py-3 bg-white text-teal-900 rounded-full font-bold shadow-xl hover:scale-105 transition">Simpan Gambar</button><button class="block w-full mt-2 text-sm text-white/50 hover:text-white" data-bs-dismiss="modal">Tutup</button></div></div></div></div>

    <div id="previewOverlay" class="fixed inset-0 z-[60] bg-black/95 hidden flex-col transition-all duration-300"><div class="flex justify-between items-center p-4 border-b border-white/10 bg-slate-900"><h4 class="text-white font-bold truncate pr-4 text-lg" id="previewTitle">Preview</h4><div class="flex items-center gap-3"><button onclick="toggleFullscreen()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 text-white transition"><i data-lucide="maximize" class="w-5 h-5" id="iconFs"></i></button><button onclick="tutupPreview()" class="p-2 bg-red-500/20 rounded-full hover:bg-red-500 text-white transition"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 p-0 md:p-4 bg-black relative" id="previewContainer"><div id="detailLoader" class="absolute inset-0 flex items-center justify-center text-white"><div class="spinner-border text-teal-500"></div></div><iframe id="previewFrame" class="w-full h-full rounded-none md:rounded-xl bg-white hidden border-0"></iframe></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxCTYyM2VjFQzfLKKIcYevkivH4TerMrU7jYakvJxR75_yXULW_YmKFy7nYrdBhnOAq/exec";
        const CACHE_KEY = 'gb_v1_stable';
        let STATE = { all:[], filtered:[], user:{name:"Tamu",role:"GUEST",school:"-"}, settings:[], limit:12, favMode:false };
        let modalInput = null;

        if(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }

        window.onload = function() {
            lucide.createIcons();
            modalInput = new bootstrap.Modal(document.getElementById('modalInput'));
            try { let u = localStorage.getItem('gbUser'); if(u) STATE.user = JSON.parse(u); } catch(e){}
            updateUI();
            loadData();
            setSource('LINK');
            document.addEventListener('fullscreenchange', () => { const icon = document.getElementById('iconFs'); icon.setAttribute('data-lucide', document.fullscreenElement ? 'minimize' : 'maximize'); lucide.createIcons(); });
        };

        function switchView(v) { document.getElementById('view-galeri').classList.toggle('hidden', v!=='GALERI'); document.getElementById('view-dashboard').classList.toggle('hidden', v!=='DASHBOARD'); if(v==='DASHBOARD') renderDashboard(); window.scrollTo({top:0, behavior:'smooth'}); }
        function updateUI() {
            const isGuest = STATE.user.role === 'GUEST';
            const authBtn = document.getElementById('authBtn');
            if(authBtn) { authBtn.innerHTML = isGuest ? `LOGIN` : `Hi, ${STATE.user.name.split(' ')[0]}`; authBtn.onclick = isGuest ? loginModal : () => switchView('DASHBOARD'); }
            document.getElementById('menuGuest')?.classList.toggle('hidden', !isGuest);
            document.getElementById('menuUser')?.classList.toggle('hidden', isGuest);
            document.getElementById('menuGuruItems')?.classList.toggle('hidden', isGuest);
            document.getElementById('btnAdd')?.classList.toggle('hidden', isGuest);
            if(!isGuest) { 
                if(document.getElementById('menuName')) document.getElementById('menuName').innerText = STATE.user.name; 
                if(document.getElementById('menuAv')) document.getElementById('menuAv').innerText = STATE.user.name.charAt(0); 
            }
            lucide.createIcons();
        }
        async function loadData() { try { document.getElementById('loader').classList.remove('hidden'); let res = await fetch(API_URL + "?action=read"); let json = await res.json(); if(json.status === 'success') { STATE.all = json.media || []; STATE.settings = json.settings || []; populateSelects(); runFilter(); } document.getElementById('loader').classList.add('hidden'); } catch(e) { document.getElementById('loader').classList.add('hidden'); document.getElementById('emptyState').classList.remove('hidden'); } }

        function getTypeStyle(type) {
            type = (type || "").toUpperCase();
            if (type.includes('VIDEO')) return { grad: "from-rose-500 to-red-600", icon: "play-circle" };
            if (type.includes('GAME')) return { grad: "from-violet-500 to-purple-600", icon: "gamepad-2" };
            if (type.includes('STORY') || type.includes('EBOOK') || type.includes('BUKU')) return { grad: "from-amber-400 to-orange-500", icon: "book-open" };
            return { grad: "from-teal-400 to-emerald-500", icon: "file-text" };
        }

        function renderGaleri() { 
            const c = document.getElementById('galeri-container'); c.innerHTML = ''; 
            const show = STATE.filtered.slice(0, STATE.limit);
            if(show.length === 0) { document.getElementById('emptyState').classList.remove('hidden'); document.getElementById('loadMoreContainer').classList.add('hidden'); return; }
            document.getElementById('emptyState').classList.add('hidden');

            show.forEach(item => { 
                const idx = STATE.all.indexOf(item);
                const id = item[13];
                const saved = JSON.parse(localStorage.getItem('GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'))||'[]');
                const isSaved = saved.includes(id);
                
                const type = (item[11] || "UMUM").toUpperCase();
                const style = getTypeStyle(type); 
                const yt = getYoutubeId(item[8]||"");
                let thumb = yt 
                    ? `<img src="https://img.youtube.com/vi/${yt}/mqdefault.jpg" class="w-full h-full object-cover group-hover:scale-110 transition duration-500"><div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition"></div><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="w-8 h-8 text-white opacity-80 group-hover:scale-125 transition"></i></div>` 
                    : `<div class="w-full h-full bg-gradient-to-br ${style.grad} flex items-center justify-center group-hover:scale-110 transition duration-500"><i data-lucide="${style.icon}" class="w-8 h-8 md:w-16 md:h-16 text-white/50 -rotate-12 group-hover:rotate-0 transition"></i></div>`;
                
                const typeBadge = `<div class="absolute top-2 left-2 px-2 py-1 rounded-md bg-black/50 backdrop-blur-sm text-white text-[8px] md:text-[9px] font-bold border border-white/20 shadow-sm z-10 flex items-center gap-1"><i data-lucide="${style.icon}" class="w-3 h-3"></i> ${type}</div>`;
                
                // === FIX 1: REMOVE REDUNDANT "FASE" TEXT ===
                let faseText = item[3] || "";
                if (faseText && !faseText.toLowerCase().startsWith('fase')) { faseText = "Fase " + faseText; }
                const faseBadge = faseText ? `<span class="px-2 py-0.5 rounded-md bg-gradient-to-r from-teal-500 to-emerald-500 text-white text-[8px] md:text-[9px] font-bold shadow-sm truncate max-w-[80px]">${faseText}</span>` : '';

                // === FIX 2: SOLID HEART ICON ===
                const html = `
                <div class="group custom-card shadow-sm hover:shadow-xl hover:-translate-y-1 cursor-pointer overflow-hidden" onclick="bukaPreview(${idx})">
                    <div class="card-thumb relative bg-slate-100 dark:bg-slate-900 overflow-hidden">${thumb}${typeBadge}
                        <div class="absolute top-2 right-2 hidden md:flex desktop-only"><button onclick="event.stopPropagation(); toggleSimpan('${id}')" class="w-8 h-8 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-white hover:bg-red-500 hover:text-white transition ${isSaved?'bg-red-500':''}"><i data-lucide="heart" class="w-4 h-4 ${isSaved?'fill-current':''}"></i></button></div>
                    </div>
                    <div class="card-body">
                        <div>
                            <div class="flex flex-wrap gap-1 mb-1 items-center"><span class="px-2 py-0.5 rounded-md bg-slate-100 dark:bg-slate-700/50 text-[8px] md:text-[9px] font-bold text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-700">${item[6]||"Umum"}</span>${faseBadge}</div>
                            <h3 class="font-bold text-sm leading-snug mb-3 line-clamp-2 text-slate-900 dark:text-white group-hover:text-primary transition">${item[5]||"Tanpa Judul"}</h3>
                        </div>
                        <div class="mt-auto pt-2 border-t border-slate-100 dark:border-slate-700 flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-teal-500 to-emerald-500 p-[1px] flex-shrink-0"><div class="w-full h-full rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-900 dark:text-white">${(item[1]||"U").charAt(0)}</div></div>
                            <div class="flex flex-col truncate min-w-0"><span class="text-[10px] font-bold text-slate-800 dark:text-slate-200 truncate">${item[1]||"Guru"}</span><span class="text-[9px] text-slate-400 dark:text-slate-500 truncate">${item[2]||"-"}</span></div>
                        </div>
                    </div>
                    <div class="md:hidden absolute bottom-3 right-3 mobile-only"><button onclick="event.stopPropagation(); toggleSimpan('${id}')" class="text-slate-300 dark:text-slate-600 ${isSaved?'!text-red-500':''}"><i data-lucide="heart" class="w-5 h-5 ${isSaved?'fill-current':''}"></i></button></div>
                </div>`;
                c.insertAdjacentHTML('beforeend', html);
            }); 
            lucide.createIcons(); 
            document.getElementById('loadMoreContainer').classList.toggle('hidden', STATE.filtered.length <= STATE.limit);
        }

        function renderDashboard() { 
            const user = STATE.user; document.getElementById('dashName').innerText = user.name; document.getElementById('dashSchool').innerText = user.school; document.getElementById('dashAv').innerText = user.name.charAt(0); 
            const myWorks = STATE.all.filter(i => (i[1]||"").trim().toLowerCase() === user.name.toLowerCase());
            const c = document.getElementById('dash-list-container'); c.innerHTML = ''; 
            let lvl = "PEMULA üå±"; if(myWorks.length>=100) lvl = "SUHU üëë"; else if(myWorks.length>=25) lvl = "TELADAN ‚≠ê";
            document.getElementById('lvlBadgeContainer').innerHTML = `<span class="px-3 py-1 bg-teal-600 text-white rounded-full text-xs font-bold shadow">${lvl}</span>`;
            if(myWorks.length === 0) { c.innerHTML = '<div class="col-span-full text-center py-10 opacity-60 text-slate-500 dark:text-slate-400">Belum ada karya.</div>'; return; }
            myWorks.forEach(item => {
                const idx = STATE.all.indexOf(item);
                const status = item[9] === 'DISETUJUI' ? '<span class="text-teal-600 text-[10px] font-bold">Tayang</span>' : '<span class="text-yellow-500 text-[10px] font-bold">Pending</span>';
                c.insertAdjacentHTML('beforeend', `<div class="custom-card !flex-row p-4 items-center gap-4 !h-auto"><div class="w-12 h-12 rounded-xl bg-teal-500/10 text-teal-600 flex items-center justify-center font-bold flex-shrink-0">${(item[11]||"D").charAt(0)}</div><div class="flex-1 truncate min-w-0"><div class="font-bold text-sm truncate text-slate-900 dark:text-white">${item[5]}</div><div class="flex gap-3 text-xs opacity-60 text-slate-500 dark:text-slate-400"><span>${item[14]||0} Views</span>${status}</div></div><div class="flex gap-2 flex-shrink-0"><button onclick="bukaEdit(${idx})" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-600 dark:text-white"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="hapusKarya(${idx})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`);
            });
            lucide.createIcons(); 
        }

        function toggleFullscreen() { const elem = document.getElementById('previewContainer'); if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => { alert(`Error: ${err.message}`); }); } else { if(document.exitFullscreen) document.exitFullscreen(); } }
        function getYoutubeId(u){ var m=u.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (m&&m[2].length==11)?m[2]:false; }
        function loginModal() { Swal.fire({title: 'Login Guru', input: 'password', showCancelButton: true, confirmButtonColor: '#0d9488', confirmButtonText: 'Masuk'}).then((r) => { if (r.isConfirmed) { fetch(API_URL, {method:'POST', body:JSON.stringify({action:'login', payload:{pin:r.value}})}).then(res=>res.json()).then(res => { if(res.status === 'success') { STATE.user = res.user; localStorage.setItem('gbUser', JSON.stringify(res.user)); updateUI(); Swal.close(); switchView('DASHBOARD'); } else { Swal.fire('Gagal', 'PIN Salah', 'error'); } }); } }) }
        function logout(){ localStorage.removeItem('gbUser'); STATE.user={name:"Tamu",role:"GUEST"}; updateUI(); switchView('GALERI'); }
        function clickFab(){ document.getElementById('modalForm').reset(); document.getElementById('formMode').value="ADD"; setSource('LINK'); modalInput.show(); }
        function toggleKaih(c) { document.getElementById('kaihBox').classList.toggle('hidden', !c); }
        function loadMoreItems() { STATE.limit += 12; renderGaleri(); }
        function toggleSimpan(id){ var k='GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'); var s=JSON.parse(localStorage.getItem(k)||'[]'); if(s.includes(id))s=s.filter(x=>x!==id); else s.push(id); localStorage.setItem(k,JSON.stringify(s)); renderGaleri(); }
        
        function filterSimpanan(){ 
            STATE.favMode = !STATE.favMode; // Toggle mode
            const btn = document.getElementById('btnFavDesk');
            
            // Visual Toggle Button Desktop
            if(STATE.favMode) {
                btn.classList.add('bg-red-500', 'text-white');
                btn.classList.remove('text-red-500', 'border-red-500');
                btn.querySelector('svg').classList.add('fill-current'); // Solid Heart
                
                var k='GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'); 
                var s=JSON.parse(localStorage.getItem(k)||'[]'); 
                STATE.filtered=STATE.all.filter(i=>s.includes(i[13])); 
            } else {
                btn.classList.remove('bg-red-500', 'text-white');
                btn.classList.add('text-red-500', 'border-red-500');
                btn.querySelector('svg').classList.remove('fill-current'); // Outline Heart
                runFilter(); // Reset to normal filter
                return;
            }
            renderGaleri(); 
        }
        
        function runFilter() { 
            STATE.favMode = false; // Reset fav mode if filtering
            // Reset visual btn favorite
            const btn = document.getElementById('btnFavDesk');
            if(btn) { btn.classList.remove('bg-red-500', 'text-white'); btn.classList.add('text-red-500'); btn.querySelector('svg').classList.remove('fill-current'); }

            STATE.limit = 12; const q = (document.getElementById('deskSearchInput').value || document.getElementById('mobSearchInput').value).toLowerCase(); const fMapel = document.getElementById('filterMapel').value; const fFase = document.getElementById('filterFase').value; STATE.filtered = STATE.all.filter(i => { const text = ((i[5]||"")+" "+(i[1]||"")+" "+(i[6]||"")).toLowerCase(); return text.includes(q) && (fMapel==="" || i[6]===fMapel) && (fFase==="" || i[3]===fFase); }); renderGaleri(); 
        }
        
        function filterSemua() { document.getElementById('filterMapel').value=""; document.getElementById('filterFase').value=""; runFilter(); }
        function closeMenu(){ bootstrap.Offcanvas.getInstance(document.getElementById('sideMenu'))?.hide(); }
        function populateSelects(){ const f = (id, idx) => { const el = document.getElementById(id); el.innerHTML = '<option value="">Semua</option>'; STATE.settings.forEach(r => { if(r[idx]) el.innerHTML += `<option value="${r[idx]}">${r[idx]}</option>`; }); }; f('filterMapel', 1); f('filterFase', 2); const fm = (id, idx) => { const el = document.getElementById(id); el.innerHTML = '<option value="">Pilih...</option>'; STATE.settings.forEach(r => { if(r[idx]) el.innerHTML += `<option value="${r[idx]}">${r[idx]}</option>`; }); el.innerHTML += '<option value="LAINNYA">Lainnya...</option>'; }; fm('inMapel', 1); fm('inJenis', 0); fm('inFase', 2); fm('inSem', 4); fm('inKaihType', 3); }
        async function bukaPreview(idx) { const item = STATE.all[idx]; const link = item[8] || ""; const isExt = link.includes('canva') || link.includes('gemini') || (item[11]||"").toUpperCase().includes('STORY'); fetch(API_URL, {method:'POST', body:JSON.stringify({action:'view', payload:{id:item[13]}})}); if(link && isExt) { window.open(link, '_blank'); return; } document.getElementById('previewTitle').innerText = item[5]; document.getElementById('previewOverlay').classList.remove('hidden'); document.getElementById('previewOverlay').classList.add('flex'); document.getElementById('previewFrame').classList.add('hidden'); document.getElementById('detailLoader').classList.remove('hidden'); let finalUrl = link; let htmlContent = item[7]; if(htmlContent === "HAS_HTML") { let r = await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'getDetail', payload:{id:item[13]}})}).then(res=>res.json()); htmlContent = r.html; STATE.all[idx][7] = r.html; } document.getElementById('detailLoader').classList.add('hidden'); document.getElementById('previewFrame').classList.remove('hidden'); if(htmlContent && htmlContent.length > 10) { const blob = new Blob([htmlContent], {type: 'text/html'}); document.getElementById('previewFrame').src = URL.createObjectURL(blob); } else if(link) { if(link.includes('drive.google')) finalUrl = link.replace('/view', '/preview'); if(link.includes('youtu')) { const vid = getYoutubeId(link); if(vid) finalUrl = `https://www.youtube.com/embed/${vid}?autoplay=1`; } document.getElementById('previewFrame').src = finalUrl; } }
        function tutupPreview() { document.getElementById('previewOverlay').classList.add('hidden'); document.getElementById('previewOverlay').classList.remove('flex'); document.getElementById('previewFrame').src = ''; if (document.fullscreenElement) document.exitFullscreen(); }
        function prosesSimpan(){ const p = { judul: document.getElementById('inJudul').value, mapel: document.getElementById('inMapel').value === 'LAINNYA' ? document.getElementById('manMapel').value : document.getElementById('inMapel').value, jenis: document.getElementById('inJenis').value === 'LAINNYA' ? document.getElementById('manJenis').value : document.getElementById('inJenis').value, fase: document.getElementById('inFase').value, semester: document.getElementById('inSem').value, linkLuar: document.getElementById('inputSourceType').value === 'STORY' ? document.getElementById('inLinkStory').value : document.getElementById('inLink').value, kodeHtml: document.getElementById('inputSourceType').value === 'HTML' ? document.getElementById('inHtml').value : "", nama: STATE.user.name, sekolah: STATE.user.school, mode: document.getElementById('formMode').value, idUnik: document.getElementById('editRowIdx').value, kaihType: document.getElementById('checkKaih').checked ? document.getElementById('inKaihType').value : "" }; if(!p.judul) { Swal.fire('Error','Judul wajib diisi','warning'); return; } Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()}); fetch(API_URL, { method:'POST', body:JSON.stringify({action:'simpan', payload:p}) }).then(r=>r.json()).then(d=>{ Swal.fire('Berhasil','Karya disimpan!','success'); localStorage.removeItem(CACHE_KEY); modalInput.hide(); loadData(); }); }
        function hapusKarya(idx) { Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'}).then(r=>{ if(r.isConfirmed) { Swal.showLoading(); fetch(API_URL, { method:'POST', body:JSON.stringify({action:'hapus', payload:{id:STATE.all[idx][13]}}) }).then(()=>{ Swal.fire('Terhapus','','success'); localStorage.removeItem(CACHE_KEY); loadData(); }); } }); }
        function bukaEdit(idx) { const d = STATE.all[idx]; document.getElementById('formMode').value = "EDIT"; document.getElementById('editRowIdx').value = d[13]; document.getElementById('inJudul').value = d[5]; const setSel = (id, v, mid) => { const el = document.getElementById(id); if([...el.options].some(o=>o.value===v)) { el.value=v; document.getElementById(mid).classList.add('hidden'); } else { el.value='LAINNYA'; document.getElementById(mid).value=v; document.getElementById(mid).classList.remove('hidden'); } }; setSel('inMapel', d[6], 'manMapel'); setSel('inJenis', d[11], 'manJenis'); document.getElementById('inFase').value = d[3]; document.getElementById('inSem').value = d[4]; const h = d[7]||""; const l = d[8]||""; if(h.length > 10 || h === 'HAS_HTML') { setSource('HTML'); if(h !== 'HAS_HTML') document.getElementById('inHtml').value = h; } else if((d[11]||"").includes('STORY')) { setSource('STORY'); document.getElementById('inLinkStory').value = l; } else { setSource('LINK'); document.getElementById('inLink').value = l; } modalInput.show(); }
        function downloadCard(){ html2canvas(document.getElementById("cardArea"), {scale:3, backgroundColor:null}).then(c=>{ var l=document.createElement("a"); l.download=`Kartu_${STATE.user.name}.png`; l.href=c.toDataURL(); l.click(); Swal.fire('Disimpan','Kartu berhasil diunduh','success'); }); }
        function openCardModal(){ const w=STATE.all.filter(i=>i[1]===STATE.user.name); document.getElementById('cardName').innerText=STATE.user.name; document.getElementById('cardSchool').innerText=STATE.user.school; document.getElementById('cardAvatar').innerText=STATE.user.name.charAt(0); document.getElementById('cardKaryaCount').innerText=w.length; document.getElementById('cardViewCount').innerText=w.reduce((a,b)=>a+(parseInt(b[14])||0),0); new bootstrap.Modal(document.getElementById('modalCetakKartu')).show(); }
        function setSource(t) { document.querySelectorAll('.btn-source').forEach(btn => btn.classList.remove('active')); const activeId = t==='LINK'?'btnSrcLink':t==='STORY'?'btnSrcStory':'btnSrcHtml'; document.getElementById(activeId).classList.add('active'); ['groupLink','groupStory','groupHtml'].forEach(id => document.getElementById(id).classList.add('hidden')); if(t==='LINK') document.getElementById('groupLink').classList.remove('hidden'); else if(t==='STORY') document.getElementById('groupStory').classList.remove('hidden'); else document.getElementById('groupHtml').classList.remove('hidden'); document.getElementById('inputSourceType').value = t; updateLivePreview(); }
        function checkOther(id, mid, v) { document.getElementById(mid).classList.toggle('hidden', v !== 'LAINNYA'); if(v === 'LAINNYA') document.getElementById(mid).focus(); }
        function updateLivePreview(){ var t=document.getElementById('inputSourceType').value, v=""; if(t==='LINK')v=document.getElementById('inLink').value; else if(t==='STORY')v=document.getElementById('inLinkStory').value; else v=document.getElementById('inHtml').value; var d=document.getElementById('miniPreviewFrame').contentDocument; d.open(); d.write('<style>body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#f1f5f9;color:#64748b;font-family:sans-serif;font-size:12px;text-align:center;}</style>'); if(t==='STORY') d.write("Preview Storybook<br>(Link luar)"); else if(t==='HTML') d.write(v || "Preview Embed"); else { var y=getYoutubeId(v); if(y) d.write(`<iframe src="https://www.youtube.com/embed/${y}" style="width:100%;height:100%;border:none"></iframe>`); else d.write("Preview Link"); } d.close(); }
    </script>
</body>
</html>