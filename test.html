<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guru Berbagi - Selogiri</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root { 
      --primary: #2D8B83; 
      --primary-dark: #1F6660;
      --accent: #f59e0b;
      --bg-body: #f1f5f9; 
      --text-main: #1e293b;
      --text-muted: #64748b;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    body { background-color: var(--bg-body); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); font-size: 0.9rem; padding-bottom: 80px; }

    /* NAVBAR & LAYOUT */
    .navbar { z-index: 1000; position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e2e8f0; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .brand-container { display: flex; align-items: center; gap: 12px; }
    .brand-logo-box { width: 48px; height: 48px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(45, 139, 131, 0.3); color: white; }
    .brand-text { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; }
    .brand-main { font-weight: 800; color: var(--primary); font-size: 1.4rem; letter-spacing: -0.5px; }
    .brand-sub { font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

    /* FILTERS AREA */
    .filter-container { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: var(--card-shadow); }
    .form-select-filter { border-radius: 20px; border: 1px solid #cbd5e1; font-size: 0.85rem; font-weight: 600; color: #475569; }
    .form-select-filter:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(45, 139, 131, 0.2); }

    /* CARD SYSTEM */
    .card-karya { 
      background: #fff; border: 1px solid #fff; border-radius: 16px; 
      overflow: hidden; height: 100%; display: flex; flex-direction: column; 
      transition: all 0.2s ease-in-out; position: relative;
      box-shadow: var(--card-shadow);
    }
    .card-karya:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
    
    .card-thumb { 
      height: 150px; position: relative; overflow: hidden; 
      display: flex; align-items: center; justify-content: center; 
      background: #e2e8f0; color: #fff;
    }
    
    .view-badge { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; backdrop-filter: blur(2px); font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; z-index: 5; font-weight: 700; }
    .kaih-compact { display: inline-flex; align-items: center; gap: 4px; font-size: 0.65rem; color: #b45309; background-color: #fffbeb; padding: 3px 8px; border-radius: 20px; font-weight: 700; margin-top: 6px; border: 1px solid #fcd34d; width: fit-content; }
    .btn-wishlist { position: absolute; top: 8px; right: 8px; z-index: 10; border: none; background: rgba(255,255,255,0.9); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #94a3b8; transition: 0.2s; cursor: pointer; }
    .btn-wishlist:hover, .btn-wishlist.active { color: #ef4444; transform: scale(1.1); }
    .card-body-mp { padding: 16px; flex-grow: 1; display: flex; flex-direction: column; }
    .mp-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
    .badge-pill { font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; }
    .bg-soft-teal { background: #e0f2f1; color: #00695c; } 
    .bg-soft-blue { background: #e0f7fa; color: #0277bd; border: 1px solid #b3e5fc; } 
    .bg-soft-purple { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; } 
    .mp-title { font-weight: 800; font-size: 1rem; line-height: 1.35; margin-bottom: 2px; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.7em; }
    .guru-info { display: flex; align-items: center; gap: 10px; margin-top: auto; padding-top: 12px; border-top: 1px dashed #e2e8f0; }
    .guru-avatar { width: 32px; height: 32px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem; color: #64748b; }
    .action-row { margin-top: 12px; display: flex; gap: 8px; position: relative; z-index: 5; }
    .btn-open { background: var(--primary); color: white; border: none; padding: 8px 0; border-radius: 8px; font-weight: 700; font-size: 0.8rem; flex-grow: 1; transition: 0.2s; box-shadow: 0 4px 6px rgba(45, 139, 131, 0.2); }
    .btn-open:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-icon { width: 36px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; color: #475569; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
    .btn-icon:hover { background: #f8fafc; color: #0f172a; border-color: #94a3b8; }
    .btn-icon.danger:hover { color: #ef4444; border-color: #ef4444; background: #fef2f2; }
    .fab-add { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 20px; background: #1e293b; color: white; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); transition: 0.3s; display: flex; align-items: center; justify-content: center; z-index: 1020; }
    .fab-add:hover { transform: scale(1.1) rotate(90deg); background: var(--primary); }

    /* DASHBOARD PROFIL STYLES */
    .profile-header { background: white; padding: 24px; border-radius: 16px; display: flex; align-items: center; gap: 20px; border: 1px solid #e2e8f0; margin-bottom: 24px; box-shadow: var(--card-shadow); }
    .profile-avatar-big { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; }
    .stat-box { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; box-shadow: var(--card-shadow); }
    .stat-num { font-size: 2rem; font-weight: 800; color: var(--primary); line-height: 1; }
    .stat-lbl { font-size: 0.8rem; font-weight: 600; color: #64748b; text-transform: uppercase; margin-top: 4px; }
    .btn-filter-my { background: #ffffff; color: var(--primary); border: 1px solid var(--primary); }
    .btn-filter-my:hover, .btn-filter-my.active { background: var(--primary); color: white; }

    /* PREVIEW OVERLAY & MODAL */
    #previewOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; z-index: 20000; }
    .preview-head { background: #111; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; border-bottom: 1px solid #333; flex-shrink: 0; position: relative; opacity: 1; transition: opacity 0.3s ease; }
    #previewOverlay:fullscreen .preview-head { position: absolute; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); border-bottom: none; z-index: 20001; opacity: 0; }
    #previewOverlay:fullscreen .preview-head:hover { opacity: 1; }
    #floatingExitBtn { position: fixed; top: 20px; right: 20px; z-index: 20002; background: rgba(220, 38, 38, 0.8); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); backdrop-filter: blur(4px); transition: 0.3s; cursor: pointer; }
    #floatingExitBtn:hover { background: rgba(220, 38, 38, 1); transform: scale(1.1); }
    #previewOverlay:fullscreen #floatingExitBtn { display: flex; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #previewFrame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #fff; }
    #detailLoader { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; text-align:center; display:none; }
    .preview-box { width: 100%; height: 100%; min-height: 350px; border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; background: #f8fafc; position: relative; }
    .preview-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; font-weight: 700; text-align: center; }
    
    .transition-all { transition: all 0.3s ease; }
    .transition-all:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(45, 139, 131, 0.2) !important; }
    .d-none { display: none !important; }
  </style>
</head>
<body>

  <div id="previewOverlay">
    <button id="floatingExitBtn" onclick="tutupFullscreen()" title="Keluar Layar Penuh"><i class="fas fa-times fa-lg"></i></button>
    <div class="preview-head" id="overlayControls">
      <div class="fw-bold text-truncate pe-3" id="previewTitle" style="font-size:1.1rem; color:#f8fafc;">Preview</div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnFs" class="btn btn-sm btn-outline-light rounded-pill fw-bold" onclick="smartFullscreen()" title="Layar Penuh"><i class="fas fa-expand me-1"></i> FULLSCREEN</button>
        <button class="btn btn-sm btn-danger rounded-pill fw-bold px-3" onclick="tutupPreview()">TUTUP</button>
      </div>
    </div>
    <div id="detailLoader"><div class="spinner-border mb-2"></div><div>Memuat Konten...</div></div>
    <iframe id="previewFrame" allowfullscreen allow="autoplay; encrypted-media; picture-in-picture"></iframe>
  </div>

  <nav class="navbar">
    <div class="container d-flex flex-column flex-md-row gap-3 justify-content-between align-items-center">
      <div class="brand-container">
        <div class="brand-logo-box"><i data-lucide="screen-share" style="width: 28px; height: 28px;"></i></div>
        <div class="brand-text"><div class="brand-main">GURU BERBAGI</div><div class="brand-sub">Korwilcambidik Kecamatan Selogiri</div></div>
      </div>
      
      <div id="searchWrapper" class="d-flex align-items-center bg-white px-3 py-2 rounded-pill border" style="width:100%; max-width:450px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
        <i class="fas fa-search text-muted me-2"></i>
        <input type="text" id="searchInput" oninput="handleSearchInput(this.value)" class="form-control border-0 p-0 shadow-none bg-transparent" placeholder="Cari karya, mapel, guru...">
      </div>

      <div class="d-flex align-items-center gap-2">
        <button id="btnHome" class="btn btn-outline-secondary btn-sm rounded-pill fw-bold px-3 d-none" onclick="switchView('GALERI')">Kembali ke Galeri</button>
        <button id="btnDashboard" class="btn btn-warning btn-sm rounded-pill fw-bold shadow-sm text-dark d-none" onclick="switchView('DASHBOARD')"><i class="fas fa-user-circle me-1"></i> Profil Saya</button>
        <button id="btnLogin" class="btn btn-outline-primary btn-sm rounded-pill fw-bold px-4" onclick="loginModal()">Login Guru</button>
        <div id="userPanel" class="d-none d-flex align-items-center gap-3">
          <button onclick="logout()" class="btn btn-light btn-sm rounded-circle border text-danger" title="Logout"><i class="fas fa-power-off"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <div id="view-galeri" class="container mt-4 fade-in">
    <div class="filter-container row g-2 mb-4 align-items-center">
       <div class="col-md-3">
         <select id="filterMapel" class="form-select form-select-filter" onchange="applyFilters()">
            <option value="">Semua Mata Pelajaran</option>
         </select>
       </div>
       <div class="col-md-3">
         <select id="filterFase" class="form-select form-select-filter" onchange="applyFilters()">
            <option value="">Semua Fase / Kelas</option>
         </select>
       </div>
       <div class="col-md-6 d-flex justify-content-md-end gap-2">
         <button onclick="filterSemua()" class="btn btn-sm btn-dark rounded-pill px-4 fw-bold shadow-sm">Semua</button>
         <button onclick="filterSimpanan()" class="btn btn-sm btn-white border rounded-pill px-4 fw-bold text-danger shadow-sm"><i class="fas fa-heart me-1"></i> Favorit</button>
       </div>
    </div>
    <div id="loader" class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    <div id="galeri-container" class="row gx-3 gx-md-4 gy-4"></div>
    <div id="loadMoreContainer" class="text-center mt-5 d-none">
       <button onclick="loadMoreItems()" class="btn btn-outline-primary rounded-pill px-4 fw-bold shadow-sm transition-all">Muat Lebih Banyak <i class="fas fa-chevron-down ms-1"></i></button>
       <div class="small text-muted mt-2" id="loadMoreInfo"></div>
    </div>
  </div>

  <div id="view-dashboard" class="container mt-4 d-none fade-in">
     <div class="profile-header">
        <div class="profile-avatar-big" id="dashAvatar">U</div>
        <div>
           <h3 class="fw-800 mb-0" id="dashName">Nama Guru</h3>
           <div class="text-muted" id="dashSchool">Nama Sekolah</div>
           <div class="mt-2"><span class="badge bg-primary rounded-pill">GURU</span></div>
        </div>
     </div>

     <div class="row g-3 mb-4">
        <div class="col-md-6">
           <div class="stat-box">
              <div class="stat-num" id="dashTotal">0</div>
              <div class="stat-lbl">Total Karya Saya</div>
           </div>
        </div>
        <div class="col-md-6">
           <div class="stat-box">
              <div class="stat-num text-warning" id="dashViews">0</div>
              <div class="stat-lbl">Total Dilihat</div>
           </div>
        </div>
     </div>

     <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Daftar Karya Saya</h5>
        <button class="btn btn-primary btn-sm rounded-pill fw-bold px-4" onclick="resetForm(); showModalInput()"><i class="fas fa-plus me-2"></i>Tambah Karya</button>
     </div>
     
     <div id="dash-list-container" class="row gx-3 gx-md-4 gy-4"></div>
  </div>

  <button id="btnAdd" class="fab-add d-none" onclick="resetForm(); showModalInput()"><i class="fas fa-plus"></i></button>

  <div class="modal fade" id="modalInput" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content rounded-4 border-0 shadow">
        <div class="modal-header border-bottom bg-light py-3"><h5 class="fw-bold text-primary mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Bagikan Karya</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body p-4 bg-white">
          <form id="modalForm">
            <input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editRowIdx">
            <div class="row h-100">
              <div class="col-lg-7 modal-left-col border-end pe-4">
                <div class="mb-3"><label class="small fw-bold mb-1 text-muted">Judul Media <span class="text-danger">*</span></label><input type="text" id="inJudul" class="form-control fw-bold bg-light" placeholder="Judul karya..."></div>
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="small fw-bold mb-1 text-muted">Mata Pelajaran <span class="text-danger">*</span></label><select id="inMapel" class="form-select" onchange="checkDropdown('inMapel','manMapel',this.value)"></select><input type="text" id="manMapel" class="form-control mt-2 d-none" placeholder="Tulis mapel..." required></div>
                  <div class="col-md-6 mb-3"><label class="small fw-bold mb-1 text-muted">Jenis Media <span class="text-danger">*</span></label><select id="inJenis" class="form-select" onchange="checkDropdown('inJenis','manJenis',this.value)"></select><input type="text" id="manJenis" class="form-control mt-2 d-none" placeholder="Tulis jenis..." required></div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="small fw-bold mb-1 text-muted">Fase / Kelas</label><select id="inFase" class="form-select"></select></div>
                  <div class="col-md-6 mb-3"><label class="small fw-bold mb-1 text-muted">Semester</label><select id="inSem" class="form-select"></select></div>
                </div>
                <div class="bg-light p-3 rounded mb-3 border d-flex align-items-center justify-content-between">
                  <div><label class="small fw-bold d-block text-dark">Program KAIH?</label><small class="text-muted" style="font-size:0.7rem;">Kebiasaan Anak Indonesia Hebat</small></div>
                  <div class="d-flex align-items-center gap-2">
                    <div id="kaihBox" class="d-none"><select id="inKaihType" class="form-select form-select-sm"></select></div>
                    <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkKaih" onchange="toggleKaih(this.checked)"></div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="small fw-bold mb-2 text-muted">Tipe Konten Utama</label>
                  <select id="inputSourceType" class="form-select bg-light fw-bold" onchange="toggleInputSource(this.value)">
                    <option value="LINK">ðŸ”— Media Umum (Youtube / Drive / Quizizz)</option>
                    <option value="STORY">ðŸ“– Link Storybook / Web App</option>
                    <option value="HTML">ðŸ’» Kode Embed HTML (Prioritas)</option>
                  </select>
                </div>
                
                <div id="groupLink" class="mb-2"><label class="small fw-bold mb-1 text-muted">Link Media</label><input type="url" id="inLink" class="form-control" placeholder="Paste link disini (termasuk link Gemini)..." oninput="updateLivePreview()"><div class="form-text small text-muted">Pastikan link bisa diakses publik (Anyone with the link).</div></div>
                <div id="groupStory" class="mb-2 d-none"><label class="small fw-bold mb-1 text-primary">Link Storybook (Gemini)</label><input type="url" id="inLinkStory" class="form-control border-primary" placeholder="Paste link Storybook disini..." oninput="updateLivePreview()"><div class="form-text small text-muted"><i class="fas fa-info-circle me-1"></i>Link ini akan otomatis dibuka di Tab Baru.</div></div>
                <div id="groupHtml" class="mb-0 d-none"><label class="small fw-bold mb-1 text-muted">Kode Embed HTML</label><textarea id="inHtml" class="form-control small font-monospace bg-light" rows="3" placeholder="<iframe src='...'></iframe>" oninput="updateLivePreview()"></textarea></div>
              </div>
              <div class="col-lg-5 d-flex flex-column pt-3 pt-lg-0">
                <label class="small fw-bold text-muted mb-2 text-center">Live Preview Thumbnail</label>
                <div class="preview-box shadow-sm">
                  <div class="preview-placeholder">Preview akan muncul disini</div>
                  <iframe id="miniPreviewFrame" style="width:100%; height:100%; border:none; position:relative; z-index:2;"></iframe>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer bg-light"><button type="button" class="btn btn-outline-secondary rounded-pill fw-bold px-4" data-bs-dismiss="modal">Batal</button><button type="button" onclick="prosesSimpan()" class="btn btn-primary rounded-pill fw-bold px-5 shadow-sm">SIMPAN & TERBITKAN</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    // --- KONFIGURASI ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxxr1uHQbJ2vf_yA59RP8YeHBwrdD4nRlbr0BP0nR0A84eSMCrLp7RR7RjrGVEXQHhP/exec";
    const CACHE_KEY_DATA = 'guruBerbagi_data_lite';
    const CACHE_DURATION = 5 * 60 * 1000; 

    var STATE = { 
        allMedia: [], filtered: [], 
        user: { name: "Tamu", role: "GUEST", school: "-" }, 
        settings: [],
        displayedLimit: 12, itemsPerPage: 12 
    };
    
    var ACTIVE_CONTENT = { type: null, data: null };
    var searchTimeout = null;
    var modalInputInstance = null;

    // --- API HANDLER ---
    async function callApi(action, payload = null) {
      try {
        if (action === 'read') {
           const cached = localStorage.getItem(CACHE_KEY_DATA);
           if (cached) {
               const { timestamp, data } = JSON.parse(cached);
               if (new Date().getTime() - timestamp < CACHE_DURATION) {
                   return data;
               }
           }
           var response = await fetch(API_URL + "?action=read");
           var json = await response.json();
           if(json.status === 'success') {
               try {
                   localStorage.setItem(CACHE_KEY_DATA, JSON.stringify({
                       timestamp: new Date().getTime(),
                       data: json
                   }));
               } catch(e) {}
           }
           return json;
        } else {
           if(['simpan', 'hapus'].includes(action)) { localStorage.removeItem(CACHE_KEY_DATA); }
           var response = await fetch(API_URL, {
             method: "POST",
             body: JSON.stringify({ action: action, payload: payload })
           });
           return await response.json();
        }
      } catch (e) { console.error("API Error:", e); return { status: "error", message: e.toString() }; }
    }

    // INIT
    window.onload = function() { 
        lucide.createIcons();
        initApp(); 
    };
    function initApp() {
      try { var saved = localStorage.getItem('guruBerbagiUser'); if (saved) { STATE.user = JSON.parse(saved); updateUserInterface(); } } catch(e) {}
      loadData();
    }

    function cleanStr(str) { if(!str) return ""; return str.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\n/g, " "); }
    function softReset() { updateUserInterface(); loadData(); if(STATE.user.role!=='GUEST') switchView('DASHBOARD'); else switchView('GALERI'); }

    function updateUserInterface() {
      var isGuest = (STATE.user.role === 'GUEST');
      document.getElementById('btnLogin').classList.toggle('d-none', !isGuest);
      document.getElementById('userPanel').classList.toggle('d-none', isGuest);
      
      // Toggle Dashboard Button (Profil Saya)
      document.getElementById('btnDashboard').classList.toggle('d-none', isGuest);
      
      // Toggle FAB
      document.getElementById('btnAdd').classList.add('d-none');
      if (!isGuest && document.getElementById('view-galeri').classList.contains('d-none') === false) {
         document.getElementById('btnAdd').classList.remove('d-none');
      }
    }
    
    function switchView(viewName) {
        var g = document.getElementById('view-galeri');
        var d = document.getElementById('view-dashboard');
        var s = document.getElementById('searchWrapper');
        var btnHome = document.getElementById('btnHome');
        var btnDash = document.getElementById('btnDashboard');
        var btnAdd = document.getElementById('btnAdd');

        if (viewName === 'DASHBOARD') {
            g.classList.add('d-none');
            d.classList.remove('d-none');
            s.style.visibility = 'hidden'; // Hide search on dashboard
            btnHome.classList.remove('d-none');
            btnDash.classList.add('d-none');
            btnAdd.classList.add('d-none');
            renderUserDashboard();
        } else {
            g.classList.remove('d-none');
            d.classList.add('d-none');
            s.style.visibility = 'visible';
            btnHome.classList.add('d-none');
            if(STATE.user.role !== 'GUEST') {
                btnDash.classList.remove('d-none');
                btnAdd.classList.remove('d-none');
            }
        }
    }

    function loadData() {
      callApi('read').then(function(res) {
        if(res && res.status === "success") {
          STATE.allMedia = res.media; STATE.settings = res.settings;
          populateDropdowns(); 
          applyFilters();      
        }
        document.getElementById('loader').style.display = 'none';
      });
    }

    // --- SEARCH & FILTER ---
    function handleSearchInput(val) {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { applyFilters(); }, 400); 
    }

    function applyFilters() {
      var q = document.getElementById('searchInput').value.toLowerCase();
      var fMapel = document.getElementById('filterMapel').value;
      var fFase = document.getElementById('filterFase').value;
      STATE.filtered = STATE.allMedia.filter(function(i) {
         var haystack = (i[5]+" "+i[1]+" "+i[2]+" "+i[3]+" "+i[6]+" "+i[11]).toLowerCase();
         var matches = haystack.indexOf(q)!==-1 && ((fMapel==="") || (i[6]===fMapel)) && ((fFase==="") || (i[3]===fFase));
         return matches;
      });
      STATE.displayedLimit = STATE.itemsPerPage;
      renderGaleri();
    }

    function loadMoreItems() { STATE.displayedLimit += STATE.itemsPerPage; renderGaleri(); }

    function renderGaleri() {
      var c = document.getElementById('galeri-container'); c.innerHTML = '';
      var favKey = 'GB_FAV_' + (STATE.user ? STATE.user.name : 'GUEST');
      var saved = JSON.parse(localStorage.getItem(favKey) || '[]');
      var dataToShow = STATE.filtered.slice(0, STATE.displayedLimit);
      
      dataToShow.forEach(function(item) {
        var realIndex = STATE.allMedia.indexOf(item);
        var id = cleanStr(item[13]);
        var isOwner = (STATE.user.name === item[1]);
        var isSaved = saved.includes(id);
        var iconLove = isSaved ? 'fas fa-heart text-danger' : 'far fa-heart';
        
        var kaihHtml = item[10] ? '<div class="kaih-compact"><i class="fas fa-star text-warning"></i>'+cleanStr(item[10])+'</div>' : '';
        
        var html = '<div class="col-6 col-md-4 col-lg-3 d-flex"><div class="card-karya w-100"><div class="card-thumb">' + getThumbnailHtml(cleanStr(item[11]), item[8]) + '<div class="view-badge"><i class="fas fa-eye me-1"></i> ' + (item[14]||0) + '</div><button onclick="event.stopPropagation(); toggleSimpan(\'' + id + '\')" class="btn-wishlist '+(isSaved?'active':'')+'"><i class="' + iconLove + '"></i></button></div><div class="card-body-mp"><div class="mp-tags"><span class="badge-pill bg-soft-teal">' + cleanStr(item[6]) + '</span><span class="badge-pill bg-soft-blue">' + cleanStr(item[3]) + '</span><span class="badge-pill bg-soft-purple">' + cleanStr(item[4]) + '</span></div><div class="mp-title" title="'+cleanStr(item[5])+'">' + cleanStr(item[5]) + '</div>' + kaihHtml + '<div class="guru-info"><div class="guru-avatar">' + cleanStr(item[1]).charAt(0) + '</div><div style="overflow:hidden; line-height:1.2;"><div class="text-truncate fw-bold" style="font-size:0.75rem">' + cleanStr(item[1]) + '</div><div class="text-muted text-truncate" style="font-size:0.65rem">' + cleanStr(item[2]) + '</div></div></div><div class="action-row"><button onclick="bukaPreview(' + realIndex + ')" class="btn-open">BUKA KARYA</button></div></div></div></div>';
        c.insertAdjacentHTML('beforeend', html);
      });

      var btnMore = document.getElementById('loadMoreContainer');
      if (STATE.filtered.length > STATE.displayedLimit) { btnMore.classList.remove('d-none'); document.getElementById('loadMoreInfo').innerText = `Menampilkan ${dataToShow.length} dari ${STATE.filtered.length} karya`; } else { btnMore.classList.add('d-none'); }
      if (STATE.filtered.length === 0) c.innerHTML = `<div class="col-12 text-center py-5 text-muted"><i class="fas fa-search fa-3x mb-3 text-secondary opacity-25"></i><br>Tidak ada karya ditemukan.</div>`;
    }

    // --- RENDER DASHBOARD PROFIL USER ---
    function renderUserDashboard() {
        document.getElementById('dashName').innerText = STATE.user.name;
        document.getElementById('dashSchool').innerText = STATE.user.school;
        document.getElementById('dashAvatar').innerText = STATE.user.name.charAt(0);
        
        var myWorks = STATE.allMedia.filter(i => i[1] === STATE.user.name);
        
        var totalViews = 0;
        myWorks.forEach(w => totalViews += parseInt(w[14] || 0));
        
        document.getElementById('dashTotal').innerText = myWorks.length;
        document.getElementById('dashViews').innerText = totalViews;
        
        var c = document.getElementById('dash-list-container'); c.innerHTML = '';
        if(myWorks.length === 0) {
            c.innerHTML = '<div class="col-12 text-center py-5 text-muted">Belum ada karya yang diupload.</div>';
            return;
        }
        
        myWorks.forEach(function(item) {
            var realIndex = STATE.allMedia.indexOf(item);
            var html = `<div class="col-6 col-md-4 col-lg-3 d-flex"><div class="card-karya w-100">
                <div class="card-thumb" style="height:120px;">${getThumbnailHtml(cleanStr(item[11]), item[8])}
                <div class="view-badge"><i class="fas fa-eye me-1"></i> ${item[14]||0}</div></div>
                <div class="card-body-mp p-3">
                   <div class="mp-title" style="font-size:0.9rem;">${cleanStr(item[5])}</div>
                   <div class="text-muted small mb-2">${cleanStr(item[6])}</div>
                   <div class="d-flex gap-2 mt-auto">
                      <button onclick="bukaEdit(${realIndex})" class="btn btn-sm btn-outline-secondary flex-grow-1"><i class="fas fa-edit"></i></button>
                      <button onclick="hapusKarya(${realIndex})" class="btn btn-sm btn-outline-danger flex-grow-1"><i class="fas fa-trash"></i></button>
                      <button onclick="bukaPreview(${realIndex})" class="btn btn-sm btn-primary"><i class="fas fa-play"></i></button>
                   </div>
                </div></div></div>`;
            c.insertAdjacentHTML('beforeend', html);
        });
    }

    function filterSemua() { document.getElementById('searchInput').value = ""; document.getElementById('filterMapel').value = ""; document.getElementById('filterFase').value = ""; applyFilters(); }
    function filterSimpanan() { var k='GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'), s=JSON.parse(localStorage.getItem(k)||'[]'); STATE.filtered = STATE.allMedia.filter(i=>s.includes(i[13])); STATE.displayedLimit=STATE.itemsPerPage; renderGaleri(); }

    function getYoutubeId(url) { var match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (match && match[2].length == 11) ? match[2] : false; }
    function getThumbnailHtml(jenis, link) {
      let ic = "fas fa-code"; let bg = "#475569"; let j = (jenis || "").toUpperCase();
      if(j.includes("VIDEO")) { ic="fas fa-play"; bg="#ef4444"; } else if(j.includes("MODUL")) { ic="fas fa-book-open"; bg="#10b981"; } else if(j.includes("GAME")) { ic="fas fa-gamepad"; bg="#8b5cf6"; } else if(j.includes("KUIS")) { ic="fas fa-stopwatch"; bg="#f59e0b"; } else if(j.includes("STORY") || j.includes("BUKU")) { ic="fas fa-book-reader"; bg="#d97706"; }
      var ytId = getYoutubeId(link || ""); if (ytId) return `<img src="https://img.youtube.com/vi/${ytId}/mqdefault.jpg" loading="lazy" style="width:100%; height:100%; object-fit:cover;">`;
      return `<div style="background:${bg}; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;"><i class="${ic} fa-3x mb-2"></i><span style="font-size:0.6rem; font-weight:800;">${j}</span></div>`;
    }

    // --- SHARE & PREVIEW ENGINE (LAZY LOAD) ---
    async function bukaPreview(index) {
      var item = STATE.allMedia[index]; if(!item) return;
      var rawHtml = (item[7] || "").trim(), rawLink = (item[8] || "").trim(), id = item[13];
      
      callApi('view', { id: id });
      document.getElementById('previewTitle').innerText = cleanStr(item[5]);
      var overlay = document.getElementById('previewOverlay'), frame = document.getElementById('previewFrame');
      var loader = document.getElementById('detailLoader');
      
      overlay.style.display = 'flex'; 
      loader.style.display = 'none';
      frame.style.display = 'block'; 
      frame.src = "about:blank";

      if (rawLink && (rawLink.indexOf('gemini.google.com')!==-1 || rawLink.indexOf('g.co')!==-1)) {
          ACTIVE_CONTENT = { type: 'GEMINI', data: rawLink };
          var finalUrl = rawLink.includes('gemini.google.com/share') ? rawLink.replace('gemini.google.com/share', 'g.co/gemini/share') : rawLink;
          window.open(finalUrl, '_blank'); return;
      }

      if (rawHtml === "HAS_HTML") {
           loader.style.display = 'block'; frame.style.display = 'none';
           var res = await callApi('getDetail', {id: id});
           if(res.status === 'success') {
               rawHtml = res.html; item[7] = rawHtml; 
           } else {
               Swal.fire('Error', 'Gagal memuat konten HTML.', 'error');
               return;
           }
           loader.style.display = 'none'; frame.style.display = 'block';
      }

      if (rawHtml.length > 10) {
          ACTIVE_CONTENT = { type: 'HTML', data: rawHtml };
          var blob = new Blob([rawHtml], { type: 'text/html' }); frame.src = URL.createObjectURL(blob); frame.dataset.blob = frame.src; return;
      }
      if (rawLink.length > 5) {
          ACTIVE_CONTENT = { type: 'LINK', data: rawLink };
          var finalUrl = rawLink, ytId = getYoutubeId(rawLink);
          if (ytId) { finalUrl = "https://www.youtube.com/embed/" + ytId + "?autoplay=1&rel=0&modestbranding=1"; } 
          else if (finalUrl.indexOf('drive.google.com') !== -1) { finalUrl = finalUrl.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview'); }
          frame.src = finalUrl; return;
      }
      Swal.fire('Info', 'Konten kosong.', 'info'); tutupPreview();
    }

    function smartFullscreen() {
      var elem = document.getElementById("previewOverlay"); var req = elem.requestFullscreen || elem.webkitRequestFullscreen || elem.msRequestFullscreen;
      if (req) { var promise = req.call(elem); if (promise && typeof promise.catch === 'function') { promise.catch(function(err) { fallbackTabBaru(); }); } } else { fallbackTabBaru(); }
    }
    function fallbackTabBaru() {
      Swal.fire({ title: 'Mode Tab Baru', text: 'Membuka konten di tab baru agar tampilan maksimal.', icon: 'info', timer: 1500, showConfirmButton: false });
      setTimeout(function() {
        if (!ACTIVE_CONTENT.data) return;
        if (ACTIVE_CONTENT.type === 'HTML') { var win = window.open("", "_blank"); if (win) { win.document.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>Layar Penuh</title><style>body{margin:0;padding:0;overflow-y:auto;} #content{width:100%;min-height:100vh;border:none;}</style></head><body><div id="content">' + ACTIVE_CONTENT.data + '</div></body></html>'); win.document.close(); } } 
        else if (ACTIVE_CONTENT.type === 'LINK') { var ytId = getYoutubeId(ACTIVE_CONTENT.data); window.open(ytId ? "https://www.youtube.com/embed/"+ytId+"?autoplay=1" : ACTIVE_CONTENT.data, '_blank'); }
      }, 500);
    }
    function tutupFullscreen() { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); }
    function tutupPreview() { if (document.fullscreenElement) tutupFullscreen(); var overlay = document.getElementById('previewOverlay'), frame = document.getElementById('previewFrame'); overlay.style.display = 'none'; frame.src = ""; if(frame.dataset.blob) { URL.revokeObjectURL(frame.dataset.blob); frame.dataset.blob = ""; } }

    function showModalInput() { if (!modalInputInstance) modalInputInstance = new bootstrap.Modal(document.getElementById('modalInput'), {backdrop:'static', keyboard:false}); modalInputInstance.show(); }
    function resetForm() { document.getElementById('modalForm').reset(); document.getElementById('formMode').value="ADD"; document.getElementById('inputSourceType').value = 'LINK'; toggleInputSource('LINK'); updateLivePreview(); toggleKaih(false); document.getElementById('manMapel').classList.add('d-none'); document.getElementById('manJenis').classList.add('d-none'); }

    function prosesSimpan() {
        var judul = document.getElementById('inJudul').value; if(!judul) { Swal.fire('Error', 'Judul wajib diisi', 'error'); return; }
        var mapel = document.getElementById('inMapel').value; if(mapel === 'LAINNYA') mapel = document.getElementById('manMapel').value;
        var jenis = document.getElementById('inJenis').value; if(jenis === 'LAINNYA') jenis = document.getElementById('manJenis').value;
        var mode = document.getElementById('formMode').value;
        var payload = {
            nama: STATE.user.name, sekolah: STATE.user.school || "-", judul: judul, mapel: mapel, jenis: jenis,
            fase: document.getElementById('inFase').value, 
            semester: document.getElementById('inSem').value,
            kaihType: document.getElementById('checkKaih').checked ? document.getElementById('inKaihType').value : "",
            linkLuar: document.getElementById('inputSourceType').value === 'STORY' ? document.getElementById('inLinkStory').value : document.getElementById('inLink').value,
            kodeHtml: document.getElementById('inputSourceType').value === 'HTML' ? document.getElementById('inHtml').value : "",
            mode: mode
        };
        if(mode === 'EDIT') payload.idUnik = document.getElementById('editRowIdx').value;
        
        Swal.fire({title: 'Menyimpan...', didOpen:()=>{Swal.showLoading()}});
        callApi('simpan', payload).then(res => { if(res.status === 'success') { Swal.fire('Berhasil', 'Karya berhasil disimpan!', 'success'); bootstrap.Modal.getInstance(document.getElementById('modalInput')).hide(); loadData(); softReset(); } else { Swal.fire('Gagal', res.message, 'error'); } });
    }

    function bukaEdit(index) {
      var d = STATE.allMedia[index]; if(!d) return;
      document.getElementById('formMode').value = "EDIT"; document.getElementById('editRowIdx').value = d[13];
      document.getElementById('inJudul').value = d[5]; document.getElementById('inFase').value = d[3]; document.getElementById('inSem').value = d[4];
      if (d[7] === "HAS_HTML") {
          Swal.fire({title:'Memuat data...', didOpen:()=>{Swal.showLoading()}});
          callApi('getDetail', {id: d[13]}).then(res => {
              if(res.status==='success') { d[7] = res.html; isiFormEdit(d); Swal.close(); }
          });
      } else {
          isiFormEdit(d);
      }
    }

    function isiFormEdit(d) {
      var hasHtml = (d[7] && d[7].length > 5), hasLink = (d[8] && d[8].length > 5);
      if(hasHtml) { document.getElementById('inputSourceType').value = 'HTML'; toggleInputSource('HTML'); document.getElementById('inHtml').value = d[7]; } 
      else if (hasLink && (d[8].includes('g.co') || d[8].includes('gemini'))) { document.getElementById('inputSourceType').value = 'STORY'; toggleInputSource('STORY'); document.getElementById('inLinkStory').value = d[8]; } 
      else { document.getElementById('inputSourceType').value = 'LINK'; toggleInputSource('LINK'); document.getElementById('inLink').value = d[8]; }
      setValOrOther('inMapel', d[6], 'manMapel'); setValOrOther('inJenis', d[11], 'manJenis');
      var isKaih = d[10] && d[10] !== ""; document.getElementById('checkKaih').checked = isKaih; toggleKaih(isKaih); if(isKaih) document.getElementById('inKaihType').value = d[10];
      updateLivePreview(); showModalInput();
    }

    function setValOrOther(elId, val, manId) { var el = document.getElementById(elId); if(Array.from(el.options).some(o => o.value === val)) { el.value = val; checkDropdown(elId, manId, val); } else { el.value = 'LAINNYA'; checkDropdown(elId, manId, 'LAINNYA'); document.getElementById(manId).value = val; } }
    function toggleInputSource(type) { ['groupLink','groupStory','groupHtml'].forEach(id => document.getElementById(id).classList.add('d-none')); if(type === 'LINK') document.getElementById('groupLink').classList.remove('d-none'); else if (type === 'STORY') document.getElementById('groupStory').classList.remove('d-none'); else if (type === 'HTML') document.getElementById('groupHtml').classList.remove('d-none'); updateLivePreview(); }
    function checkDropdown(selectId, manualInputId, val) { var man = document.getElementById(manualInputId); if (val === 'LAINNYA') { man.classList.remove('d-none'); man.focus(); } else { man.classList.add('d-none'); man.value = ""; } }
    function toggleKaih(checked) { document.getElementById('kaihBox').classList.toggle('d-none', !checked); }

    function populateDropdowns() { 
      var f = function(id,idx,oth) { var el=document.getElementById(id); if(!el)return; el.innerHTML='<option value="">Pilih</option>'; STATE.settings.forEach(r => {if(r[idx])el.innerHTML+=`<option value="${r[idx]}">${r[idx]}</option>`}); if(oth)el.innerHTML+='<option value="LAINNYA">LAINNYA</option>'; }; 
      f('inJenis',0,true); f('inMapel',1,true); f('inFase',2); f('inKaihType',3); f('inSem', 4);
      var fFilter = function(id, idx) { var el = document.getElementById(id); if(!el) return; el.innerHTML = '<option value="">Semua</option>'; STATE.settings.forEach(r => { if(r[idx]) el.innerHTML += `<option value="${r[idx]}">${r[idx]}</option>` }); };
      fFilter('filterMapel', 1); fFilter('filterFase', 2);
    }

    function updateLivePreview() { 
      var type = document.getElementById('inputSourceType').value;
      var val = "";
      if(type==='LINK') val = document.getElementById('inLink').value; 
      else if(type==='STORY') val = document.getElementById('inLinkStory').value; 
      else if(type==='HTML') val = document.getElementById('inHtml').value;
      
      var doc = document.getElementById('miniPreviewFrame').contentDocument; 
      doc.open();
      
      var baseStyle = `<style>body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; color: #333; } img { max-width: 100%; height: auto; } iframe { width: 100%; aspect-ratio: 16/9; border: none; }</style>`;
      
      if (type === 'STORY' || (type === 'LINK' && (val.includes('gemini.google.com') || val.includes('g.co')))) { 
          doc.write(baseStyle + '<div style="text-align:center;color:#666;padding-top:20px;">ðŸ“– Storybook<br><small>Preview tersedia setelah dibuka</small></div>'); 
      } 
      else if(type==='HTML' && val.length > 5) { doc.write(baseStyle + val); } 
      else if (val.length > 5) { 
          var ytId = getYoutubeId(val); 
          var src = ytId ? "https://www.youtube.com/embed/"+ytId : val; 
          doc.write(`<body style="margin:0;overflow:hidden;"><iframe src="${src}" style="width:100%;height:100%;border:none;"></iframe></body>`); 
      } 
      else { doc.write('<div style="text-align:center;color:#ccc;font-family:sans-serif;padding-top:40px;">Preview</div>'); } 
      doc.close(); 
    }

    function hapusKarya(index) { 
        var item = STATE.allMedia[index]; if(!item) return;
        Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true}).then(r=>{ if(r.isConfirmed) { callApi('hapus', {id: item[13]}).then(function(){ loadData(); softReset(); }); } });
    }

    function toggleSimpan(id) { var k='GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'),s=JSON.parse(localStorage.getItem(k)||'[]'); if(s.includes(id))s=s.filter(i=>i!==id);else s.push(id); localStorage.setItem(k,JSON.stringify(s)); renderGaleri(); }

    function loginModal() { 
      Swal.fire({title:'PIN Guru',input:'password'}).then(r=>{ 
        if(r.value) {
          Swal.fire({title: 'Login...', didOpen:()=>{Swal.showLoading()}});<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Guru Berbagi - Selogiri</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root { 
      --primary: #2D8B83; 
      --primary-dark: #1F6660;
      --bg-body: #f8fafc; 
      --text-main: #1e293b;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    body { background-color: var(--bg-body); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); font-size: 0.9rem; padding-bottom: 90px; }

    /* --- DESKTOP NAVBAR --- */
    .navbar-top { background: #fff; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1020; transition: all 0.3s; }
    .brand-container { display: flex; align-items: center; gap: 12px; }
    .brand-logo-box { width: 42px; height: 42px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }
    
    /* --- MOBILE BOTTOM NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0 15px 0; z-index: 1030; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
    .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; width: 20%; text-decoration: none; transition: 0.2s; }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item i { font-size: 1.2rem; }
    .nav-fab { width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -30px; border: 4px solid var(--bg-body); box-shadow: 0 4px 10px rgba(45,139,131,0.4); transition: transform 0.2s; }
    .nav-fab:active { transform: scale(0.9); }

    /* --- CARD SYSTEM --- */
    .card-karya { background: #fff; border: none; border-radius: 16px; overflow: hidden; box-shadow: var(--card-shadow); height: 100%; display: flex; flex-direction: column; transition: transform 0.2s; }
    .card-karya:active { transform: scale(0.98); }
    .card-thumb { height: 140px; position: relative; background: #e2e8f0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .view-badge { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: 700; backdrop-filter: blur(4px); }
    .card-body-mp { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
    .mp-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
    .tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
    .tag-blue { background: #e0f7fa; color: #0277bd; }
    .mp-title { font-weight: 700; font-size: 0.95rem; line-height: 1.3; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* --- DASHBOARD & PROFILE --- */
    .profile-header { background: white; padding: 24px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); text-align: center; position: relative; overflow: hidden; }
    .prof-av-lg { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; font-size: 2rem; font-weight: 800; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; border: 4px solid #e0f2f1; }
    .medal-badge { font-size: 0.75rem; padding: 6px 14px; border-radius: 20px; font-weight: 800; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; }
    
    /* --- CARD CREATOR (HIDDEN CANVAS) --- */
    #cardArea { width: 300px; height: 480px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; position: relative; overflow: hidden; border-radius: 16px; text-align: start; margin: 0 auto; }
    
    /* --- UTILITIES --- */
    .d-none { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* --- PREVIEW OVERLAY --- */
    #previewOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; z-index: 20000; }
    #previewFrame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #fff; }
    .preview-head { background: #111; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; color: white; border-bottom: 1px solid #333; }
    #detailLoader { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; text-align:center; display:none; width: 100%; }

    /* --- RESPONSIVE ADJUSTMENTS --- */
    @media (min-width: 768px) {
        .bottom-nav { display: none !important; } /* Hide Bottom Nav on Desktop */
        body { padding-bottom: 0; }
    }
  </style>
</head>
<body>

  <nav class="navbar-top py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="brand-container">
        <div class="brand-logo-box"><i data-lucide="screen-share" style="width: 24px; height: 24px;"></i></div>
        <div>
          <div style="font-weight:800; color:var(--primary); font-size:1.1rem; line-height:1.1;">GURU BERBAGI</div>
          <div style="font-size:0.65rem; color:#64748b; font-weight:600;">Kecamatan Selogiri</div>
        </div>
      </div>
      
      <div class="d-none d-md-flex gap-2 align-items-center">
         <button class="btn btn-sm btn-link text-decoration-none text-dark fw-bold" onclick="switchView('GALERI')">Galeri</button>
         <button class="btn btn-sm btn-link text-decoration-none text-dark fw-bold" onclick="filterSimpanan()">Favorit</button>
         <button class="btn btn-sm btn-outline-primary rounded-pill px-4 fw-bold" onclick="handleAuthDesktop()" id="desktopAuthBtn">Login Guru</button>
      </div>
    </div>
  </nav>

  <div class="container mt-3 mb-2" id="searchContainer">
    <div class="bg-white rounded-pill border d-flex align-items-center px-3 py-2 shadow-sm">
      <i class="fas fa-search text-muted me-2"></i>
      <input type="text" id="searchInput" oninput="handleSearchInput(this.value)" class="form-control border-0 p-0 shadow-none" placeholder="Cari karya, mapel, atau guru...">
    </div>
  </div>

  <div id="view-galeri" class="container fade-in mb-5">
    <div class="d-flex gap-2 overflow-auto pb-3 no-scrollbar" style="scrollbar-width: none; -ms-overflow-style: none;">
       <button onclick="filterSemua()" class="btn btn-sm btn-dark rounded-pill px-3 flex-shrink-0">Semua</button>
       <select id="filterMapel" class="form-select form-select-sm rounded-pill border bg-white" style="width:auto;" onchange="applyFilters()"><option value="">Semua Mapel</option></select>
       <select id="filterFase" class="form-select form-select-sm rounded-pill border bg-white" style="width:auto;" onchange="applyFilters()"><option value="">Semua Fase</option></select>
    </div>

    <div id="loader" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 small text-muted">Memuat karya...</div></div>
    
    <div id="galeri-container" class="row gx-3 gx-md-4 gy-4"></div>
    
    <div id="loadMoreContainer" class="text-center mt-5 d-none pb-5">
       <button onclick="loadMoreItems()" class="btn btn-outline-primary btn-sm rounded-pill px-4 fw-bold shadow-sm">Muat Lebih Banyak</button>
       <div class="small text-muted mt-2" id="loadMoreInfo"></div>
    </div>
    
    <div id="emptyState" class="text-center py-5 d-none">
        <i class="fas fa-search fa-3x text-muted opacity-25 mb-3"></i>
        <p class="text-muted">Tidak ada karya ditemukan.</p>
    </div>
  </div>

  <div id="view-dashboard" class="container d-none fade-in mb-5">
     <div class="profile-header">
        <div class="prof-av-lg" id="dashAv">U</div>
        <h5 class="fw-bold mb-0" id="dashName">Nama Guru</h5>
        <div class="small text-muted mb-2" id="dashSchool">Sekolah</div>
        
        <div id="lvlBadgeContainer" class="my-3"></div>

        <div class="d-flex justify-content-center gap-2 mt-3">
             <button onclick="openCardModal()" class="btn btn-primary btn-sm rounded-pill fw-bold px-4 shadow-sm">
                <i class="fas fa-id-card me-2"></i> Cetak Kartu
             </button>
             <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill fw-bold px-3">
                <i class="fas fa-sign-out-alt"></i>
             </button>
        </div>
     </div>

     <div class="row g-2 mb-4">
        <div class="col-6"><div class="bg-white p-3 rounded-4 border text-center shadow-sm"><div class="fw-800 fs-2 text-primary" id="dashTotal">0</div><div class="small text-muted fw-bold">Total Karya</div></div></div>
        <div class="col-6"><div class="bg-white p-3 rounded-4 border text-center shadow-sm"><div class="fw-800 fs-2 text-warning" id="dashViews">0</div><div class="small text-muted fw-bold">Total Dilihat</div></div></div>
     </div>

     <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold ps-1 mb-0">Manajemen Karya</h6>
        <button class="btn btn-sm btn-outline-primary rounded-pill d-md-none" onclick="clickFab()"><i class="fas fa-plus"></i> Tambah</button>
     </div>
     
     <div id="dash-list-container" class="row gx-2 gy-3"></div>
  </div>

  <div class="d-none d-md-block position-fixed bottom-0 end-0 p-4" style="z-index: 1030;">
      <button onclick="clickFab()" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
          <i class="fas fa-plus"></i>
      </button>
  </div>

  <div class="bottom-nav d-md-none" id="bottomNav">
     <a href="#" onclick="switchView('GALERI'); return false;" class="nav-item active" id="navHome"><i class="fas fa-home"></i><span>Beranda</span></a>
     <a href="#" onclick="focusSearch(); return false;" class="nav-item"><i class="fas fa-search"></i><span>Cari</span></a>
     <a href="#" onclick="clickFab(); return false;" class="nav-fab shadow"><i class="fas fa-plus"></i></a>
     <a href="#" onclick="filterSimpanan(); return false;" class="nav-item" id="navFav"><i class="fas fa-heart"></i><span>Favorit</span></a>
     <a href="#" onclick="openProfile(); return false;" class="nav-item" id="navProfile"><i class="fas fa-user"></i><span>Akun</span></a>
  </div>

  <div class="modal fade" id="modalCetakKartu" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 border-0">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Kartu Tanda Creator</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <div id="cardArea">
              <div style="position:absolute; top:-50px; right:-50px; width:150px; height:150px; background:rgba(255,255,255,0.1); border-radius:50%;"></div>
              <div style="position:absolute; bottom:-20px; left:-20px; width:100px; height:100px; background:rgba(255,255,255,0.05); border-radius:50%;"></div>
              <div class="p-4 d-flex flex-column h-100 justify-content-between position-relative" style="z-index:2;">
                  <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center gap-2">
                          <div style="background:white; color:var(--primary); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center;"><i data-lucide="screen-share" style="width:16px;"></i></div>
                          <div style="line-height:1.1;"><div class="fw-bold" style="font-size:0.7rem; letter-spacing:0.5px;">GURU BERBAGI</div><div style="font-size:0.5rem; opacity:0.7;">SELOGIRI</div></div>
                      </div>
                      <div class="border border-light rounded-pill px-2 py-0" style="font-size:0.6rem; opacity:0.8;"><i class="fas fa-check-circle me-1"></i>VERIFIED</div>
                  </div>
                  <div class="text-center mt-3">
                      <div class="mx-auto d-flex align-items-center justify-content-center bg-white text-dark fw-bold rounded-circle mb-3 shadow-lg" style="width:90px; height:90px; font-size:2.5rem; border:4px solid rgba(255,255,255,0.2);" id="cardAvatar">U</div>
                      <h5 class="fw-bold mb-1 text-truncate px-2" id="cardName">Nama Guru</h5>
                      <div class="small opacity-75 mb-3 text-truncate px-4" id="cardSchool">Unit Kerja</div>
                      <div class="d-inline-block px-4 py-1 rounded-pill fw-bold shadow-sm" id="cardBadgeContainer" style="background: white; color:#333; font-size:0.8rem;"><span id="cardLevel">LEVEL</span></div>
                  </div>
                  <div class="row g-2 mt-2 px-2 text-center">
                      <div class="col-6"><div class="rounded p-2" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);"><div class="h5 fw-bold mb-0" id="cardKaryaCount">0</div><small style="font-size:0.55rem; letter-spacing:1px; opacity:0.8;">KARYA</small></div></div>
                      <div class="col-6"><div class="rounded p-2" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);"><div class="h5 fw-bold mb-0" id="cardViewCount">0</div><small style="font-size:0.55rem; letter-spacing:1px; opacity:0.8;">VIEWS</small></div></div>
                  </div>
                  <div class="mt-3 px-3"><div id="cardQuote" class="fst-italic text-center opacity-75" style="font-size: 0.6rem; line-height: 1.4; border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">"Quote..."</div></div>
                  <div class="text-center mt-auto pt-2">
                      <div class="bg-white p-1 d-inline-block rounded mb-2"><img src="https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=GURU_BERBAGI_SELOGIRI" width="50" height="50"></div>
                      <div class="fw-bold" style="font-size:0.5rem; letter-spacing:1px; opacity:0.5">KORWILCAMBIDIK KECAMATAN SELOGIRI</div>
                  </div>
              </div>
          </div>
          <div class="mt-4 px-3 pb-2"><button onclick="downloadCard()" class="btn btn-primary w-100 rounded-pill fw-bold py-2 shadow"><i class="fas fa-download me-2"></i> SIMPAN GAMBAR</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalInput" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-scrollable">
      <div class="modal-content border-0">
        <div class="modal-header border-bottom-0"><h5 class="fw-bold">Upload Karya</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="modalForm">
            <input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editRowIdx">
            <div class="mb-3"><label class="small fw-bold text-muted">Judul</label><input type="text" id="inJudul" class="form-control fw-bold bg-light"></div>
            <div class="row g-2 mb-3">
              <div class="col-6"><label class="small fw-bold text-muted">Mapel</label><select id="inMapel" class="form-select" onchange="checkOther('inMapel','manMapel',this.value)"></select><input id="manMapel" class="form-control mt-1 d-none" placeholder="Lainnya..."></div>
              <div class="col-6"><label class="small fw-bold text-muted">Jenis</label><select id="inJenis" class="form-select" onchange="checkOther('inJenis','manJenis',this.value)"></select><input id="manJenis" class="form-control mt-1 d-none" placeholder="Lainnya..."></div>
            </div>
            <div class="row g-2 mb-3">
              <div class="col-6"><label class="small fw-bold text-muted">Fase</label><select id="inFase" class="form-select"></select></div>
              <div class="col-6"><label class="small fw-bold text-muted">Semester</label><select id="inSem" class="form-select"></select></div>
            </div>
            <div class="mb-3 p-3 bg-light rounded border">
               <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkKaih" onchange="toggleKaih(this.checked)"><label class="form-check-label small fw-bold">Program KAIH?</label></div>
               <select id="inKaihType" class="form-select form-select-sm mt-2 d-none"></select>
            </div>
            <div class="mb-3">
                <label class="small fw-bold text-muted">Tipe Link</label>
                <select id="sourceType" class="form-select mb-2" onchange="toggleSource(this.value)"><option value="LINK">Link Umum / Youtube</option><option value="HTML">Embed HTML (Canva/Wordwall)</option><option value="STORY">Storybook (Gemini)</option></select>
                <input type="url" id="inLink" class="form-control" placeholder="Paste link...">
                <textarea id="inHtml" class="form-control d-none font-monospace small" rows="3" placeholder="Paste kode iframe..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-top-0"><button onclick="prosesSimpan()" class="btn btn-primary w-100 rounded-pill fw-bold">SIMPAN</button></div>
      </div>
    </div>
  </div>

  <div id="previewOverlay">
    <div class="preview-head">
       <span class="fw-bold text-truncate pe-3" id="previewTitle">Preview</span>
       <button class="btn btn-sm btn-danger rounded-pill fw-bold px-3" onclick="tutupPreview()">TUTUP</button>
    </div>
    <div id="detailLoader"><div class="spinner-border mb-2"></div><div>Memuat...</div></div>
    <iframe id="previewFrame" allowfullscreen allow="autoplay"></iframe>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    // --- KONFIGURASI API ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxxr1uHQbJ2vf_yA59RP8YeHBwrdD4nRlbr0BP0nR0A84eSMCrLp7RR7RjrGVEXQHhP/exec";
    const CACHE_KEY = 'gb_data_final';
    
    // --- STATE MANAGEMENT ---
    var STATE = { 
        all:[], filtered:[], 
        user:{name:"Tamu", role:"GUEST", school:"-"}, 
        settings:[], limit:12 
    };
    var modalInput = null;

    // --- INIT ---
    window.onload = function() { 
        lucide.createIcons();
        modalInput = new bootstrap.Modal(document.getElementById('modalInput'));
        try { var u=localStorage.getItem('gbUser'); if(u) STATE.user=JSON.parse(u); } catch(e){}
        updateUI();
        loadData();
    };

    // --- NAVIGASI & UI ---
    function switchView(view) {
        document.getElementById('view-galeri').classList.toggle('d-none', view !== 'GALERI');
        document.getElementById('view-dashboard').classList.toggle('d-none', view !== 'DASHBOARD');
        
        // Active State Nav Mobile
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(view === 'GALERI') document.getElementById('navHome').classList.add('active');
        if(view === 'DASHBOARD') document.getElementById('navProfile').classList.add('active');

        if(view === 'DASHBOARD') renderDashboard();
        window.scrollTo(0,0);
    }

    function updateUI() {
        var isGuest = STATE.user.role === 'GUEST';
        var btnDesk = document.getElementById('desktopAuthBtn');
        if(btnDesk) {
            btnDesk.innerText = isGuest ? "Login Guru" : "Profil Saya";
            btnDesk.classList.toggle('btn-outline-primary', isGuest);
            btnDesk.classList.toggle('btn-primary', !isGuest);
            btnDesk.onclick = isGuest ? loginModal : function() { switchView('DASHBOARD') };
        }
    }

    function handleAuthDesktop() {
        if(STATE.user.role === 'GUEST') loginModal(); else switchView('DASHBOARD');
    }
    
    function openProfile() {
        if(STATE.user.role === 'GUEST') loginModal(); else switchView('DASHBOARD');
    }
    
    function clickFab() {
        if(STATE.user.role === 'GUEST') loginModal();
        else { 
            document.getElementById('modalForm').reset(); 
            document.getElementById('formMode').value="ADD"; 
            toggleSource('LINK');
            modalInput.show(); 
        }
    }
    
    function focusSearch() { document.getElementById('searchInput').focus(); window.scrollTo(0,0); }

    // --- DATA HANDLING ---
    async function loadData() {
        var cached = localStorage.getItem(CACHE_KEY);
        if(cached) { var c = JSON.parse(cached); if(new Date().getTime() - c.ts < 300000) { processData(c.data); return; } }
        
        try {
            var res = await fetch(API_URL + "?action=read");
            var json = await res.json();
            if(json.status === 'success') {
                localStorage.setItem(CACHE_KEY, JSON.stringify({ts:new Date().getTime(), data:json}));
                processData(json);
            }
        } catch(e) { console.error(e); }
        document.getElementById('loader').classList.add('d-none');
    }

    function processData(json) {
        STATE.all = json.media; STATE.settings = json.settings;
        populateSelects(); applyFilters();
        document.getElementById('loader').classList.add('d-none');
    }

    // --- GALERI RENDERER ---
    function renderGaleri() {
        var c = document.getElementById('galeri-container'); c.innerHTML = '';
        var show = STATE.filtered.slice(0, STATE.limit);
        
        if(show.length === 0) {
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('loadMoreContainer').classList.add('d-none');
            return;
        }
        document.getElementById('emptyState').classList.add('d-none');

        show.forEach(item => {
            var idx = STATE.all.indexOf(item);
            var html = `
            <div class="col-6 col-md-4 col-lg-3">
               <div class="card-karya" onclick="bukaPreview(${idx})">
                  <div class="card-thumb">
                     ${getThumb(item[11], item[8])}
                     <div class="view-badge"><i class="fas fa-eye me-1"></i> ${item[14]||0}</div>
                  </div>
                  <div class="card-body-mp">
                     <div class="mp-tags"><span class="tag tag-blue">${item[6]}</span></div>
                     <div class="mp-title">${item[5]}</div>
                     <div class="small text-muted mt-auto pt-2 border-top d-flex align-items-center gap-2">
                        <div style="width:20px;height:20px;background:#f1f5f9;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:bold;">${item[1].charAt(0)}</div>
                        <div class="text-truncate">${item[1]}</div>
                     </div>
                  </div>
               </div>
            </div>`;
            c.insertAdjacentHTML('beforeend', html);
        });
        
        document.getElementById('loadMoreContainer').classList.toggle('d-none', STATE.filtered.length <= STATE.limit);
        document.getElementById('loadMoreInfo').innerText = `Menampilkan ${show.length} dari ${STATE.filtered.length} karya`;
    }
    
    function loadMoreItems() { STATE.limit += 12; renderGaleri(); }

    // --- LEVEL SYSTEM 7 TIER (QUANTITY BASED) ---
    function getLevelInfo(count) {
        if(count >= 100) return { name: "SUHU ðŸ‘‘", color: "#4c1d95", bg: "linear-gradient(135deg, #4c1d95 0%, #2e1065 100%)", quote: "100 KARYA! Anda adalah legenda pendidikan Selogiri." };
        if(count >= 75)  return { name: "MAESTRO ðŸŽ¨", color: "#be123c", bg: "linear-gradient(135deg, #be123c 0%, #881337 100%)", quote: "Karya adalah seni mendidik. Terima kasih Maestro!" };
        if(count >= 50)  return { name: "MENTOR ðŸŽ“", color: "#b45309", bg: "linear-gradient(135deg, #b45309 0%, #78350f 100%)", quote: "Ilmu yang dibagi akan abadi. Terima kasih Mentor." };
        if(count >= 25)  return { name: "TELADAN â­", color: "#0e7490", bg: "linear-gradient(135deg, #0e7490 0%, #155e75 100%)", quote: "Anda adalah inspirasi bagi rekan sejawat." };
        if(count >= 10)  return { name: "PRAKTISI ðŸ”¥", color: "#15803d", bg: "linear-gradient(135deg, #15803d 0%, #14532d 100%)", quote: "Konsisten berbagi praktik baik. Lanjutkan!" };
        if(count >= 5)   return { name: "PERINTIS ðŸš©", color: "#1d4ed8", bg: "linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%)", quote: "Langkah awal telah dibuat. Teruslah berkarya!" };
        return { name: "PEMULA ðŸŒ±", color: "#64748b", bg: "linear-gradient(135deg, #64748b 0%, #334155 100%)", quote: "Ayo upload karya pertamamu sekarang!" };
    }

    function renderDashboard() {
        document.getElementById('dashName').innerText = STATE.user.name;
        document.getElementById('dashSchool').innerText = STATE.user.school;
        document.getElementById('dashAv').innerText = STATE.user.name.charAt(0);
        
        var myWorks = STATE.all.filter(i => i[1] === STATE.user.name);
        var totalViews = myWorks.reduce((acc, curr) => acc + (parseInt(curr[14])||0), 0);
        
        document.getElementById('dashTotal').innerText = myWorks.length;
        document.getElementById('dashViews').innerText = totalViews;

        // Render Badge
        var lvl = getLevelInfo(myWorks.length);
        document.getElementById('lvlBadgeContainer').innerHTML = `<span class="medal-badge" style="background:${lvl.color}; color:white;">${lvl.name}</span>`;

        // Render List
        var c = document.getElementById('dash-list-container'); c.innerHTML = '';
        if(myWorks.length === 0) c.innerHTML = '<div class="col-12 text-center text-muted py-4 small">Belum ada karya.</div>';
        
        myWorks.forEach(item => {
            var idx = STATE.all.indexOf(item);
            var html = `
            <div class="col-12">
               <div class="card p-3 rounded-4 border-0 shadow-sm d-flex flex-row align-items-center gap-3">
                  <div style="width:60px; height:60px; background:#f1f5f9; border-radius:12px; overflow:hidden; flex-shrink:0;">${getThumb(item[11], item[8])}</div>
                  <div class="flex-grow-1" style="min-width:0;">
                     <div class="fw-bold text-truncate mb-1">${item[5]}</div>
                     <div class="small text-muted"><i class="fas fa-eye me-1"></i> ${item[14]||0} Views</div>
                  </div>
                  <div class="d-flex gap-2">
                     <button onclick="bukaEdit(${idx})" class="btn btn-sm btn-light text-primary border"><i class="fas fa-pencil"></i></button>
                     <button onclick="hapusKarya(${idx})" class="btn btn-sm btn-light text-danger border"><i class="fas fa-trash"></i></button>
                  </div>
               </div>
            </div>`;
            c.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- CARD CREATOR ---
    function openCardModal() {
        var myWorks = STATE.all.filter(i => i[1] === STATE.user.name);
        var count = myWorks.length;
        var views = myWorks.reduce((acc, curr) => acc + (parseInt(curr[14])||0), 0);
        var lvl = getLevelInfo(count);

        document.getElementById('cardName').innerText = STATE.user.name;
        document.getElementById('cardSchool').innerText = STATE.user.school;
        document.getElementById('cardAvatar').innerText = STATE.user.name.charAt(0);
        document.getElementById('cardLevel').innerText = lvl.name;
        document.getElementById('cardKaryaCount').innerText = count;
        document.getElementById('cardViewCount').innerText = views;
        document.getElementById('cardQuote').innerText = `"${lvl.quote}"`;

        document.getElementById('cardArea').style.background = lvl.bg;
        document.getElementById('cardBadgeContainer').style.color = lvl.color;

        new bootstrap.Modal(document.getElementById('modalCetakKartu')).show();
    }

    function downloadCard() {
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
        btn.disabled = true;

        html2canvas(document.getElementById("cardArea"), { scale: 3, useCORS: true }).then(canvas => {
            const link = document.createElement("a");
            link.download = "Kartu-Creator-" + STATE.user.name.replace(/\s+/g, '_') + ".png";
            link.href = canvas.toDataURL("image/png");
            link.click();
            btn.innerHTML = originalText; btn.disabled = false;
            Swal.fire('Berhasil','Kartu disimpan ke galeri','success');
        });
    }

    // --- SEARCH & FILTER ---
    function handleSearchInput(v) { STATE.limit=12; var q=v.toLowerCase(); STATE.filtered = STATE.all.filter(i => (i[5]+i[1]+i[6]).toLowerCase().includes(q)); renderGaleri(); }
    function applyFilters() { handleSearchInput(document.getElementById('searchInput').value); }
    function filterSemua() { document.getElementById('searchInput').value=''; applyFilters(); }
    function filterSimpanan() { var k='GB_FAV_'+(STATE.user?STATE.user.name:'GUEST'), s=JSON.parse(localStorage.getItem(k)||'[]'); STATE.filtered = STATE.all.filter(i=>s.includes(i[13])); STATE.limit=12; renderGaleri(); }
    
    // --- UTILS ---
    function populateSelects() { 
        var f = (id, idx) => { var el = document.getElementById(id); el.innerHTML='<option value="">Semua</option>'; STATE.settings.forEach(r => { if(r[idx]) el.innerHTML+=`<option value="${r[idx]}">${r[idx]}</option>`; }); }; 
        f('filterMapel', 1); f('filterFase', 2); 
        var fm = (id, idx) => { var el = document.getElementById(id); el.innerHTML='<option value="">Pilih</option>'; STATE.settings.forEach(r => { if(r[idx]) el.innerHTML+=`<option value="${r[idx]}">${r[idx]}</option>`; }); el.innerHTML+='<option value="LAINNYA">Lainnya...</option>'; }; 
        fm('inMapel',1); fm('inJenis',0); fm('inFase',2); fm('inSem',4); 
    }

    function getThumb(type, url) { 
        var yt = url && url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^&?]*)/); 
        if(yt && yt[1].length === 11) return `<img src="https://img.youtube.com/vi/${yt[1]}/mqdefault.jpg" style="width:100%;height:100%;object-fit:cover;">`; 
        var icon="fa-file"; var t=(type||"").toUpperCase();
        if(t.includes("VIDEO")) icon="fa-play"; 
        else if(t.includes("GAME")||t.includes("KUIS")) icon="fa-gamepad";
        else if(t.includes("BUKU")||t.includes("STORY")) icon="fa-book-open";
        return `<i class="fas ${icon} fa-2x text-secondary"></i>`; 
    }

    // --- API CALLER ---
    async function callApi(act, pl) { return fetch(API_URL, {method:'POST', body:JSON.stringify({action:act, payload:pl})}).then(r=>r.json()); }

    // --- ACTIONS ---
    function loginModal() { 
        Swal.fire({title:'Login Guru', input:'password', inputPlaceholder:'Masukkan PIN', confirmButtonText:'MASUK', confirmButtonColor:'#2D8B83'}).then(r => { 
            if(r.value) { 
                Swal.showLoading(); 
                callApi('login', {pin:r.value}).then(res => { 
                    if(res.status==='success') { 
                        STATE.user = res.user; localStorage.setItem('gbUser', JSON.stringify(res.user)); 
                        updateUI(); Swal.close(); if(STATE.user.role!=='GUEST') switchView('DASHBOARD'); 
                    } else Swal.fire('Gagal', res.message, 'error'); 
                }); 
            } 
        }); 
    }
    
    function logout() { localStorage.removeItem('gbUser'); STATE.user={name:"Tamu",role:"GUEST"}; updateUI(); switchView('GALERI'); }
    
    // --- PREVIEW ENGINE (IMPROVED FOR CANVA & GEMINI) ---
    async function bukaPreview(idx) { 
        var item = STATE.all[idx]; document.getElementById('previewTitle').innerText = item[5]; 
        var ov = document.getElementById('previewOverlay'); ov.style.display='flex'; 
        var fr = document.getElementById('previewFrame'); var ld = document.getElementById('detailLoader');
        var id = item[13];
        var rawLink = item[8] || "";
        var rawHtml = item[7] || "";

        callApi('view', {id:id}); 

        // DETEKSI KHUSUS: CANVA & GEMINI (BYPASS IFRAME)
        var isCanva = rawLink.includes('canva.com') || rawLink.includes('canva.site');
        var isGemini = rawLink.includes('gemini.google.com') || rawLink.includes('g.co');

        if(rawLink && (isCanva || isGemini)) {
             fr.style.display = 'none';
             ld.style.display = 'block';
             
             var btnColor = isCanva ? "btn-primary" : "btn-warning";
             var appIcon = isCanva ? "fa-paint-brush" : "fa-robot";
             var appName = isCanva ? "Canva Presentation" : "Google Gemini";

             ld.innerHTML = `
                <div class="p-4 text-center">
                    <i class="fas ${appIcon} fa-3x mb-3 text-white"></i>
                    <h5 class="fw-bold text-white">${appName}</h5>
                    <p class="small text-white-50 mb-4">Konten ini perlu dibuka di tab baru agar tampil maksimal.</p>
                    <button onclick="window.open('${rawLink}', '_blank')" class="btn ${btnColor} rounded-pill fw-bold px-4 shadow">
                        <i class="fas fa-external-link-alt me-2"></i> BUKA SEKARANG
                    </button>
                    <div class="mt-3"><button onclick="tutupPreview()" class="btn btn-sm btn-outline-light rounded-pill">Kembali</button></div>
                </div>`;
             return;
        }

        // RESET LOADER
        ld.innerHTML = '<div class="spinner-border mb-2"></div><div>Memuat...</div>';
        ld.style.display='block'; fr.style.display='none';
        
        if(rawHtml === "HAS_HTML") { var res = await callApi('getDetail', {id:id}); rawHtml = res.html; item[7] = rawHtml; } 
        
        ld.style.display='none'; fr.style.display='block';
        if(rawHtml && rawHtml.length > 10) { var blob = new Blob([rawHtml], {type:'text/html'}); fr.src = URL.createObjectURL(blob); } 
        else if (rawLink) { 
            var url = rawLink; 
            if(url.includes('drive.google')) url = url.replace('/view','/preview'); 
            if(url.includes('youtu')) { var yid=url.match(/v=([^&]+)/); if(yid) url=`https://www.youtube.com/embed/${yid[1]}?autoplay=1`; } 
            fr.src = url; 
        } 
    }
    
    function tutupPreview() { document.getElementById('previewOverlay').style.display='none'; document.getElementById('previewFrame').src=''; }
    
    function prosesSimpan() { 
        var p = { 
            judul: document.getElementById('inJudul').value, mapel: document.getElementById('inMapel').value, jenis: document.getElementById('inJenis').value, 
            fase: document.getElementById('inFase').value, semester: document.getElementById('inSem').value, 
            linkLuar: document.getElementById('inLink').value, kodeHtml: document.getElementById('inHtml').value, 
            nama: STATE.user.name, sekolah: STATE.user.school, mode: document.getElementById('formMode').value, idUnik: document.getElementById('editRowIdx').value,
            kaihType: document.getElementById('checkKaih').checked ? document.getElementById('inKaihType').value : ""
        }; 
        Swal.showLoading(); 
        callApi('simpan', p).then(r => { Swal.fire('Sukses', '', 'success'); localStorage.removeItem(CACHE_KEY); modalInput.hide(); loadData(); }); 
    }
    
    function bukaEdit(idx) { 
        var d = STATE.all[idx]; document.getElementById('formMode').value="EDIT"; document.getElementById('editRowIdx').value=d[13]; 
        document.getElementById('inJudul').value=d[5]; 
        modalInput.show(); 
    }
    
    function hapusKarya(idx) { 
        Swal.fire({title:'Hapus Karya?', icon:'warning', showCancelButton:true}).then(r=>{ 
            if(r.isConfirmed) { callApi('hapus', {id:STATE.all[idx][13]}).then(()=>{ localStorage.removeItem(CACHE_KEY); loadData(); }); } 
        }) 
    }
    
    function toggleSource(v) { document.getElementById('inLink').classList.toggle('d-none', v==='HTML'); document.getElementById('inHtml').classList.toggle('d-none', v!=='HTML'); }
    function checkOther(id, manId, val) { document.getElementById(manId).classList.toggle('d-none', val!=='LAINNYA'); }
    function toggleKaih(checked) { document.getElementById('inKaihType').classList.toggle('d-none', !checked); }
  </script>
</body>
</html>
          callApi('login', {pin: r.value}).then(function(res){
             if(res.status==='success'){ 
                localStorage.setItem('guruBerbagiUser',JSON.stringify(res.user)); STATE.user = res.user;
                Swal.fire({icon:'success', title:'Berhasil Login', timer:800, showConfirmButton:false}).then(softReset); 
             } else {
                Swal.fire('Gagal',res.message,'error');
             }
          });
        }
      }); 
    }
    function logout() { localStorage.removeItem('guruBerbagiUser'); STATE.user = { name: "Tamu", role: "GUEST" }; softReset(); }
  </script>
</body>
</html>
