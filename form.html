<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Akun Guru Berbagi - Selogiri</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
      :root { --primary: #2c3e50; --accent: #3498db; --bg: #f0f2f5; }
      body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
      .card { background: white; width: 100%; max-width: 480px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; border-top: 5px solid var(--primary); }
      .header { text-align: center; padding: 30px 20px 10px; }
      .header img { width: 100px; margin-bottom: 15px; }
      .header h2 { margin: 0; color: var(--primary); font-size: 22px; }
      .header p { color: #7f8c8d; font-size: 14px; margin-top: 5px; }
      form { padding: 20px 30px 40px; }
      .form-group { margin-bottom: 20px; }
      label { display: block; font-weight: 600; margin-bottom: 8px; color: #34495e; font-size: 14px; }
      .required::after { content: " *"; color: red; }
      input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
      input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
      input:disabled { background-color: #eee; cursor: not-allowed; } /* Style untuk input disabled */
      
      /* Style untuk Checkbox NIP */
      .checkbox-wrapper { display: flex; align-items: center; margin-top: 8px; font-size: 13px; color: #555; }
      .checkbox-wrapper input { width: auto; margin-right: 8px; }

      #boxJabatanLainnya { display: none; margin-top: 15px; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .btn-submit { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: 0.3s; }
      .btn-submit:hover { background: #1a252f; }
      .loading { display: none; text-align: center; margin-top: 10px; font-size: 14px; color: #7f8c8d; }
      /* Modal */
      #resultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999; }
      .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 80%; width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
      .pin-box { background: #e8f6f3; color: #1abc9c; font-size: 32px; font-weight: bold; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px dashed #1abc9c; letter-spacing: 2px; }
      .btn-close { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
      <div class="header">
        <img src="https://i.imgur.com/kNgOisY.png" alt="Logo">
        <h2>Pendaftaran Akun Guru Berbagi</h2>
        <p>Korwilcambidik Kecamatan Selogiri</p>
      </div>
      <form id="guruForm">
        <div class="form-group"><label class="required">Nama Lengkap (dengan gelar)</label><input type="text" name="nama" placeholder="Contoh: Budi Santoso, S.Pd." required></div>
        
        <div class="form-group"><label class="required">Email Aktif</label><input type="email" id="emailInput" name="email" placeholder="nama@email.com" required></div>

        <div class="form-group">
            <label class="required">NIP</label>
            <input type="number" id="nipInput" name="nip" placeholder="Masukkan NIP" required>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="checkNoNip">
                <label for="checkNoNip">Saya belum memiliki NIP (Gunakan Email sebagai ID)</label>
            </div>
        </div>

        <div class="form-group">
          <label class="required">Jabatan</label>
          <select id="jabatan" name="jabatan" required><option value="" disabled selected>Memuat data...</option></select>
          <div id="boxJabatanLainnya"><label class="required">Sebutkan Jabatan Lainnya</label><input type="text" id="jabatanLainnya" name="jabatanLainnya" placeholder="Tuliskan jabatan..."></div>
        </div>
        <div class="form-group"><label class="required">Satuan Pendidikan</label><select id="satuan" name="satuan" required><option value="" disabled selected>Memuat data...</option></select></div>
        
        <div class="form-group"><label class="required">NPSN</label><input type="text" name="npsn" pattern="\d{8}" maxlength="8" minlength="8" placeholder="8 Digit Angka" required></div>
        
        <button type="submit" class="btn-submit" id="btnSubmit">Daftarkan & Generate PIN</button>
        <div class="loading" id="loadingText">Sedang memproses... Mohon tunggu.</div>
      </form>
    </div>

    <div id="resultModal">
      <div class="modal-content">
        <h3 style="color: #2c3e50; margin-top:0;">Pendaftaran Berhasil!</h3>
        <p>Halo, <span id="resNama" style="font-weight:bold;"></span>.</p>
        <p>PIN Anda adalah:</p>
        <div class="pin-box" id="resPIN">---</div>
        <p style="font-size:12px; color:#7f8c8d;">Simpan PIN ini. Salinan telah dikirim ke email.</p>
        <button class="btn-close" onclick="document.getElementById('resultModal').style.display='none'">Tutup</button>
      </div>
    </div>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbygdl97_Fikp6Al7gsaGI190G3Z-vr8LfAf0I50w_aONmIPS4CSG9eL4mu2g1jJSkyA/exec"; 

      window.onload = () => loadDropdowns();

      // --- LOGIKA BARU: CHECKBOX NIP ---
      const nipInput = document.getElementById('nipInput');
      const checkNoNip = document.getElementById('checkNoNip');

      checkNoNip.addEventListener('change', function() {
        if (this.checked) {
            nipInput.value = "";       // Kosongkan isi
            nipInput.disabled = true;  // Matikan input
            nipInput.required = false; // Matikan validasi required HTML
            nipInput.placeholder = "ID akan menggunakan Email otomatis";
        } else {
            nipInput.disabled = false; // Hidupkan input
            nipInput.required = true;  // Wajib diisi kembali
            nipInput.placeholder = "Masukkan NIP";
        }
      });

      // Logika Dropdown Jabatan
      document.getElementById('jabatan').addEventListener('change', function() {
        const box = document.getElementById('boxJabatanLainnya');
        const inp = document.getElementById('jabatanLainnya');
        if (this.value === 'Lainnya') {
          box.style.display = 'block'; inp.required = true; inp.focus();
        } else {
          box.style.display = 'none'; inp.required = false; inp.value = '';
        }
      });

      function loadDropdowns() {
        fetch(SCRIPT_URL + "?action=getDropdowns")
          .then(r => r.json())
          .then(data => {
            populate(document.getElementById('jabatan'), data.jabatan, "Pilih Jabatan", true);
            populate(document.getElementById('satuan'), data.satuan, "Pilih Sekolah", false);
          });
      }

      function populate(el, items, ph, addOther) {
        el.innerHTML = "";
        let def = document.createElement('option'); def.text = ph; def.disabled = true; def.selected = true; el.add(def);
        items.forEach(i => { let o = document.createElement('option'); o.value = i; o.text = i; el.add(o); });
        if (addOther) { let o = document.createElement('option'); o.value = "Lainnya"; o.text = "Lainnya (Isi Manual)"; el.add(o); }
      }

      // Handle Submit
      document.getElementById('guruForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cek validasi manual terakhir (jaga-jaga)
        if (!this.checkValidity()) {
            alert("Mohon lengkapi semua kolom yang bertanda bintang (*)");
            return;
        }

        const btn = document.getElementById('btnSubmit');
        const load = document.getElementById('loadingText');
        btn.style.display = 'none'; load.style.display = 'block';

        const fd = new FormData(this);
        const data = Object.fromEntries(fd.entries());

        // LOGIKA BARU: Jika NIP disabled (dicentang), isi data.nip dengan email
        if (checkNoNip.checked) {
            data.nip = data.email; 
        }

        if (data.jabatan === 'Lainnya') data.jabatan = data.jabatanLainnya;
        delete data.jabatanLainnya;

        fetch(SCRIPT_URL, {
          method: 'POST', body: JSON.stringify(data),
          headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(r => r.json())
        .then(res => {
           if (res.status === 'sukses') {
              document.getElementById('resNama').innerText = res.nama;
              document.getElementById('resPIN').innerText = res.pin;
              document.getElementById('resultModal').style.display = 'flex';
              
              // Reset Form & Kembalikan State NIP
              document.getElementById('guruForm').reset();
              document.getElementById('boxJabatanLainnya').style.display = 'none';
              checkNoNip.checked = false; // Reset checkbox
              nipInput.disabled = false;  // Reset input NIP
              nipInput.required = true;
              nipInput.placeholder = "Masukkan NIP";

           } else if (res.status === 'duplikat') {
              alert("⚠️ DATA SUDAH ADA ⚠️\n\n" + res.message);
              // Tidak reset form agar user bisa cek mana yang salah
           } else {
              alert('Error: ' + res.error);
           }
        })
        .catch(err => alert('Gagal koneksi server. Pastikan internet lancar.'))
        .finally(() => { btn.style.display = 'block'; load.style.display = 'none'; });
      });
    </script>
</body>
</html>
