<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Guru Berbagi - Mobile</title>
  
  <!-- CSS Framework: Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons: FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root { 
      --primary: #2D8B83; 
      --primary-dark: #1F6660;
      --bg-body: #f8fafc; 
      --text-main: #1e293b;
      --text-muted: #64748b;
    }

    body { 
      background-color: var(--bg-body); 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      color: var(--text-main); 
      padding-top: 125px; 
      padding-bottom: 90px;
    }

    /* --- MOBILE HEADER & NAV --- */
    .mobile-header {
      background: white; height: 60px; box-shadow: 0 1px 0px rgba(0,0,0,0.05);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1030;
      display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
    }
    .brand-logo { font-weight: 800; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 10px; line-height: 1.1; }
    .brand-logo img { height: 32px; }

    .top-tabs-container {
      position: fixed; top: 60px; left: 0; right: 0; background: white;
      padding: 8px 16px 12px 16px; z-index: 1020; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .nav-pills-custom { background: #f1f5f9; padding: 4px; border-radius: 50rem; }
    .nav-pills-custom .nav-link { color: var(--text-muted); font-weight: 600; font-size: 0.8rem; padding: 6px 12px; border-radius: 50rem; transition: all 0.2s; }
    .nav-pills-custom .nav-link.active { background-color: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* --- CARDS & LIST --- */
    .m-card {
      background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px;
      border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      display: flex; gap: 12px; align-items: start; position: relative;
    }
    .m-card:active { transform: scale(0.99); }
    
    .m-thumb {
      width: 70px; height: 70px; border-radius: 8px; background: #e2e8f0;
      flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: white;
    }
    .m-thumb img { width: 100%; height: 100%; object-fit: cover; }
    
    .m-content { flex-grow: 1; min-width: 0; padding-right: 20px; } 
    .m-title { font-weight: 700; font-size: 0.9rem; line-height: 1.3; margin-bottom: 4px; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .m-meta { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; }
    .m-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-block; margin-top: 4px; }
    .badge-mapel { background: #e0f2f1; color: #00695c; }
    
    .btn-fav {
        position: absolute; top: 8px; right: 8px; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center; color: #cbd5e1;
        background: transparent; border: none; font-size: 1.1rem; z-index: 5;
    }
    .btn-fav.is-fav { color: #ef4444; }

    .m-status { position: absolute; bottom: 12px; right: 12px; font-size: 0.65rem; font-weight: 800; padding: 2px 8px; border-radius: 10px; }
    .st-baru { background: #fef3c7; color: #b45309; }
    .st-rev { background: #fee2e2; color: #b91c1c; }
    .st-ok { background: #dcfce7; color: #166534; }

    /* --- ADMIN STATS & TABLES --- */
    .stat-card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }

    .rank-badge { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 800; font-size: 0.75rem; margin-right: 8px; }
    .rank-1 { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }
    .rank-2 { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .rank-3 { background: #fff7ed; color: #c2410c; border: 1px solid #fdba74; }
    .rank-other { background: #f8fafc; color: #94a3b8; font-size: 0.7rem; }

    /* --- UI ELEMENTS --- */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--primary); color: white; border-radius: 50%; border: none;
      box-shadow: 0 4px 12px rgba(45, 139, 131, 0.4); display: flex; align-items: center;
      justify-content: center; font-size: 1.5rem; z-index: 1040; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.9); }

    .modal-fullscreen-mobile .modal-dialog { margin: 0; width: 100%; max-width: none; height: 100%; }
    .modal-fullscreen-mobile .modal-content { height: 100%; border: 0; border-radius: 0; background: #f8fafc; }
    .modal-fullscreen-mobile .modal-body { overflow-y: auto; padding: 16px; }
    
    .form-section-title { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; margin-top: 16px; display: flex; align-items: center; gap: 8px; }
    .form-section-title::after { content:""; flex-grow: 1; height: 1px; background: #e2e8f0; }

    /* Preview Box in Form */
    .preview-box { width: 100%; height: 200px; border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; background: #e2e8f0; position: relative; margin-top: 8px; }
    .preview-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; font-weight: 700; text-align: center; font-size: 0.8rem; }

    /* Preview Overlay Fullscreen */
    #previewOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; z-index: 20000; }
    .preview-head { background: #111; padding: 12px; display: flex; justify-content: space-between; align-items: center; color: white; border-bottom: 1px solid #333; flex-shrink: 0; }
    #previewFrame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #fff; }
    
    .d-none { display: none !important; }
  </style>
</head>
<body>

  <!-- PREVIEW OVERLAY (Fullscreen) -->
  <div id="previewOverlay">
    <div class="preview-head">
      <div class="fw-bold text-truncate pe-2 text-white" id="previewTitle">Preview</div>
      <button class="btn btn-sm btn-danger rounded-pill px-3 fw-bold" onclick="tutupPreview()">TUTUP</button>
    </div>
    <iframe id="previewFrame" allowfullscreen></iframe>
  </div>

  <!-- 1. HEADER -->
  <nav class="mobile-header">
    <div class="brand-logo">
      <img src="https://i.imgur.com/kNgOisY.png" alt="Logo">
      <div>Guru Berbagi<br><small style="font-size:0.65rem; color:#64748b; font-weight:600; display:block; margin-top:0px;">Korwilcambidik Selogiri</small></div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <i class="fas fa-search text-secondary" style="font-size: 1.1rem;" onclick="toggleSearch()"></i>
      <button class="btn btn-light rounded-circle border-0 p-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuOffcanvas">
        <i class="fas fa-bars text-dark"></i>
      </button>
    </div>
  </nav>

  <!-- 2. TOP TABS -->
  <div class="top-tabs-container">
    <ul class="nav nav-pills nav-fill nav-pills-custom">
      <li class="nav-item"><a class="nav-link active" id="tab-all" href="#" onclick="switchTab('ALL')">Semua Karya</a></li>
      <li class="nav-item"><a class="nav-link" id="tab-mine" href="#" onclick="switchTab('MINE')">Karya Saya</a></li>
      <li class="nav-item"><a class="nav-link" id="tab-fav" href="#" onclick="switchTab('FAV')">Favorit</a></li>
    </ul>
  </div>

  <!-- Search Bar -->
  <div id="searchBar" class="bg-white px-3 py-2 border-bottom d-none" style="position:fixed; top:115px; left:0; right:0; z-index:1015;">
    <input type="text" id="searchInput" class="form-control rounded-pill bg-light border-0" placeholder="Cari karya, guru..." oninput="handleSearch(this.value)">
  </div>

  <!-- OFFCANVAS MENU -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="menuOffcanvas">
    <div class="offcanvas-header bg-light">
      <h5 class="offcanvas-title fw-bold text-primary">Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="guestPanel" class="text-center py-4">
        <div class="mb-3 text-muted">Anda belum login</div>
        <button onclick="loginModal()" class="btn btn-primary w-100 rounded-pill fw-bold">Login Guru</button>
      </div>
      <div id="userPanel" class="d-none">
        <div class="d-flex align-items-center gap-3 mb-4 p-3 bg-light rounded-3">
          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width:40px; height:40px;" id="uAvatar">G</div>
          <div>
            <div id="uName" class="fw-bold text-dark lh-1">Nama Guru</div>
            <small id="uRole" class="text-muted" style="font-size:0.75rem">GURU</small>
          </div>
        </div>
        
        <h6 class="fw-bold text-muted small mt-4">NAVIGASI ADMIN</h6>
        <div class="list-group list-group-flush mb-3">
           <button id="menuDashboard" onclick="switchView('ADMIN'); hideMenu();" class="list-group-item list-group-item-action border-0 px-0 d-none"><i class="fas fa-chart-pie me-2 text-warning"></i> Dashboard Admin</button>
        </div>

        <h6 class="fw-bold text-muted small mt-3">FILTER TAMBAHAN</h6>
        <div class="mb-3">
            <select id="filterMapel" class="form-select mb-2" onchange="applyFilters()"><option value="">Semua Mapel</option></select>
            <select id="filterFase" class="form-select mb-2" onchange="applyFilters()"><option value="">Semua Fase</option></select>
        </div>
        <button onclick="logout()" class="btn btn-outline-danger w-100 rounded-pill mt-4">Keluar / Logout</button>
      </div>
    </div>
  </div>

  <!-- MAIN CONTAINER -->
  <div class="container px-3 mt-2">
    
    <!-- VIEW: GALERI -->
    <div id="view-galeri">
      <div id="loader" class="text-center py-5"><div class="spinner-border text-primary"></div></div>
      <div id="list-container"></div>
      <div class="text-center mt-4 mb-5">
        <button id="btnLoadMore" onclick="loadMore()" class="btn btn-sm btn-outline-secondary rounded-pill px-4 d-none">Muat Lebih Banyak</button>
      </div>
    </div>

    <!-- VIEW: ADMIN DASHBOARD -->
    <div id="view-admin" class="d-none">
       <button onclick="switchView('GALERI')" class="btn btn-sm btn-light mb-3"><i class="fas fa-arrow-left"></i> Kembali ke Galeri</button>
       <div class="d-flex justify-content-between align-items-center mb-3">
         <h5 class="fw-bold mb-0">Dashboard Admin</h5>
         <span class="badge bg-warning text-dark" id="admRoleBadge">ADMIN</span>
       </div>

       <!-- Stats Grid -->
       <div class="row g-2 mb-4">
         <div class="col-6"><div class="stat-card flex-column align-items-start"><div class="stat-label">Total Karya</div><div class="stat-val" id="statTotal">0</div></div></div>
         <div class="col-6"><div class="stat-card flex-column align-items-start border-warning"><div class="stat-label text-warning">Menunggu</div><div class="stat-val text-warning" id="statPending">0</div></div></div>
         <div class="col-6"><div class="stat-card flex-column align-items-start border-success"><div class="stat-label text-success">Disetujui</div><div class="stat-val text-success" id="statApproved">0</div></div></div>
         <div class="col-6"><div class="stat-card flex-column align-items-start"><div class="stat-label">Total Guru</div><div class="stat-val" id="statUsers">0</div></div></div>
       </div>

       <!-- Tabs -->
       <div class="bg-white rounded-3 border p-1 mb-3">
         <div class="nav nav-pills nav-fill" style="font-size:0.8rem;">
            <button class="nav-link active btn-sm" data-bs-toggle="tab" data-bs-target="#adm-karya">Karya</button>
            <button id="tabLinkUsers" class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#adm-user" onclick="loadUserList()">Guru</button>
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#adm-rank-school" onclick="loadSchoolStats()">Sekolah</button>
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#adm-rank-teacher" onclick="loadTeacherStats()">Top Guru</button>
         </div>
       </div>

       <div class="tab-content">
         <!-- Tab Karya -->
         <div class="tab-pane fade show active" id="adm-karya">
            <div class="d-flex gap-2 mb-2">
                <input type="text" class="form-control" placeholder="Cari..." id="searchAdmKarya" oninput="adminFilter()">
                <button class="btn btn-secondary" onclick="fetchData()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="d-flex gap-2 mb-3">
                <select id="admFilterStatus" class="form-select form-select-sm" onchange="adminFilter()"><option value="">Status</option><option value="BARU">Menunggu</option><option value="DISETUJUI">Tayang</option><option value="REVISI">Revisi</option></select>
                <select id="admFilterMapel" class="form-select form-select-sm" onchange="adminFilter()"><option value="">Mapel</option></select>
            </div>
            <div id="admin-list-container"></div>
         </div>
         
         <!-- Tab User (ADMIN ONLY) -->
         <div class="tab-pane fade" id="adm-user">
            <button class="btn btn-primary w-100 rounded-pill mb-3 fw-bold" onclick="showUserModal('ADD')"><i class="fas fa-plus me-2"></i> Tambah Guru Baru</button>
            <input type="text" class="form-control mb-3" placeholder="Cari nama..." oninput="loadUserList(this.value)">
            <div id="user-list-container"></div>
         </div>

         <!-- Tab Ranking Sekolah -->
         <div class="tab-pane fade" id="adm-rank-school">
            <button class="btn btn-outline-success w-100 rounded-pill mb-3" onclick="loadSchoolStats()"><i class="fas fa-sync-alt me-2"></i> Refresh</button>
            <div id="school-rank-container"></div>
         </div>

         <!-- Tab Ranking Guru -->
         <div class="tab-pane fade" id="adm-rank-teacher">
            <button class="btn btn-outline-success w-100 rounded-pill mb-3" onclick="loadTeacherStats()"><i class="fas fa-sync-alt me-2"></i> Refresh</button>
            <div id="teacher-rank-container"></div>
         </div>
       </div>
    </div>
  </div>

  <!-- FAB -->
  <button id="fabAdd" class="fab d-none" onclick="openInputModal()"><i class="fas fa-plus"></i></button>

  <!-- MODAL: LOGIN -->
  <div class="modal fade" id="modalLogin" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0"><div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4 text-center"><div class="mb-3 text-primary"><i class="fas fa-user-lock fa-3x"></i></div><h4 class="fw-bold mb-3">Login Guru</h4><p class="text-muted small mb-4">Masukkan PIN 6 digit Anda.</p><form onsubmit="submitLogin(event)"><div class="form-floating mb-4"><input type="password" inputmode="numeric" id="loginPin" class="form-control rounded-pill text-center fs-4 letter-spacing-2" placeholder="PIN" required autocomplete="off"><label for="loginPin" class="w-100 text-center">PIN ANDA</label></div><button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2 shadow-sm">MASUK SEKARANG</button></form></div></div></div></div>

  <!-- MODAL: INPUT/EDIT (Advanced) -->
  <div class="modal fade modal-fullscreen-mobile" id="modalInput" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-bottom bg-white sticky-top">
          <h5 class="modal-title fw-bold text-primary"><i class="fas fa-pen-fancy me-2"></i>Form Karya</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formInput">
            <input type="hidden" id="formMode" value="ADD">
            <input type="hidden" id="editId">
            
            <!-- Alert Feedback -->
            <div id="feedbackAlert" class="alert alert-warning d-none mb-3">
               <div class="fw-bold small mb-1"><i class="fas fa-exclamation-triangle me-1"></i> PERLU REVISI:</div>
               <div id="feedbackMsg" class="small"></div>
            </div>

            <!-- Identitas -->
            <div class="card border-0 bg-white shadow-sm mb-3">
                <div class="card-body p-3 d-flex align-items-center gap-3">
                    <div class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold border" style="width:40px; height:40px;"><i class="fas fa-user"></i></div>
                    <div class="lh-1">
                        <small class="text-muted fw-bold" style="font-size:0.65rem">PENGIRIM:</small>
                        <div class="fw-bold text-dark" id="dispNama">-</div>
                        <div class="small text-muted" id="dispSekolah">-</div>
                    </div>
                </div>
            </div>

            <div class="form-section-title">1. Informasi Utama</div>
            <div class="bg-white p-3 rounded-3 shadow-sm border mb-3">
                <div class="form-floating mb-2">
                  <input type="text" id="inJudul" class="form-control border-0 bg-light" placeholder="Judul">
                  <label>Judul Karya (Wajib)</label>
                </div>
                <!-- Deskripsi dihapus sesuai permintaan -->
            </div>

            <div class="form-section-title">2. Detail Akademik</div>
            <div class="bg-white p-3 rounded-3 shadow-sm border mb-3">
                <div class="mb-2">
                    <label class="small fw-bold text-muted mb-1">Mata Pelajaran <span class="text-danger">*</span></label>
                    <select id="inMapel" class="form-select" onchange="checkDropdown('inMapel','manMapel',this.value)"></select>
                    <input type="text" id="manMapel" class="form-control mt-2 d-none" placeholder="Tulis Mapel Lainnya...">
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Jenis <span class="text-danger">*</span></label>
                        <select id="inJenis" class="form-select" onchange="checkDropdown('inJenis','manJenis',this.value)"></select>
                        <input type="text" id="manJenis" class="form-control mt-2 d-none" placeholder="Jenis Lain...">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Semester <span class="text-danger">*</span></label>
                        <select id="inSem" class="form-select"></select>
                    </div>
                </div>
                <div class="mb-0">
                    <label class="small fw-bold text-muted mb-1">Fase / Kelas <span class="text-danger">*</span></label>
                    <select id="inFase" class="form-select"></select>
                </div>
            </div>
            
            <div class="form-section-title">3. Tautan & Konten</div>
            <div class="bg-white p-3 rounded-3 shadow-sm border mb-4">
                <div class="mb-3">
                  <label class="small fw-bold text-muted mb-2">Tipe Konten Utama</label>
                  <select id="inputSourceType" class="form-select bg-light fw-bold" onchange="toggleInputSource(this.value)">
                    <option value="LINK">ðŸ”— Media Umum (Youtube / Drive / Quizizz)</option>
                    <option value="STORY">ðŸ“– Link Storybook (Buka di Tab Baru)</option>
                    <option value="HTML">ðŸ’» Kode Embed HTML</option>
                  </select>
                </div>

                <div id="groupLink">
                    <label class="small fw-bold text-muted mb-1">Link Media</label>
                    <input type="url" id="inLink" class="form-control" placeholder="https://..." oninput="updateLivePreview()">
                </div>
                <div id="groupStory" class="d-none">
                    <label class="small fw-bold text-primary mb-1">Link Storybook</label>
                    <input type="url" id="inLinkStory" class="form-control border-primary" placeholder="Link Story..." oninput="updateLivePreview()">
                </div>
                <div id="groupHtml" class="d-none">
                    <label class="small fw-bold text-muted mb-1">Kode Embed HTML</label>
                    <textarea id="inHtml" class="form-control font-monospace fs-6" rows="3" placeholder="<iframe src='...'></iframe>" oninput="updateLivePreview()"></textarea>
                </div>

                <!-- Live Preview Box -->
                <div class="preview-box">
                    <div class="preview-placeholder">Live Preview akan muncul disini</div>
                    <iframe id="miniPreviewFrame" style="width:100%; height:100%; border:none; position:relative; z-index:2;"></iframe>
                </div>

                <!-- KAIH Switch - Revised Layout -->
                <div class="d-flex align-items-center justify-content-between bg-light p-3 rounded border mt-3">
                    <div>
                        <label class="fw-bold small mb-0" for="checkKaih">Program KAIH</label>
                        <div class="text-muted" style="font-size:0.7rem">Kebiasaan Anak Indonesia Hebat</div>
                    </div>
                    <div class="form-check form-switch m-0">
                         <input class="form-check-input" type="checkbox" id="checkKaih" style="transform: scale(1.3);">
                    </div>
                </div>
                <select id="inKaih" class="form-select mt-2 d-none" style="width:100%"></select>

            </div>

          </form>
        </div>
        <div class="modal-footer border-top bg-white">
          <button type="button" class="btn btn-light flex-grow-1 rounded-pill fw-bold text-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" onclick="saveData()" class="btn btn-primary flex-grow-1 rounded-pill fw-bold shadow">SIMPAN & TERBITKAN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: DETAIL -->
  <div class="modal fade" id="modalDetail" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0"><div class="modal-body text-center p-4"><h5 class="fw-bold mb-2" id="detTitle">Judul</h5><p class="text-muted small mb-4" id="detGuru">Oleh: Guru</p><div class="d-grid gap-2"><button type="button" onclick="openFullscreenPreview()" class="btn btn-primary rounded-pill fw-bold py-2">BUKA KARYA</button><button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Tutup</button></div><div id="ownerActions" class="mt-3 pt-3 border-top d-none"><div class="d-flex justify-content-center gap-2"><button id="btnEdit" class="btn btn-sm btn-warning rounded-pill px-3"><i class="fas fa-edit"></i> Edit</button><button id="btnDelete" class="btn btn-sm btn-danger rounded-pill px-3"><i class="fas fa-trash"></i> Hapus</button></div></div></div></div></div></div>

  <!-- MODAL: KURASI -->
  <div class="modal fade" id="modalKurasi" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0"><div class="modal-header border-0"><h5 class="modal-title fw-bold">Kurasi Karya</h5></div><div class="modal-body"><input type="hidden" id="kurId"><label class="small fw-bold">Status</label><select id="kurStatus" class="form-select mb-3"><option value="BARU">BARU</option><option value="DISETUJUI">DISETUJUI</option><option value="REVISI">REVISI</option></select><label class="small fw-bold">Catatan Moderator</label><textarea id="kurNote" class="form-control" rows="3"></textarea></div><div class="modal-footer border-0"><button onclick="saveKurasi()" class="btn btn-primary w-100 rounded-pill">Update Status</button></div></div></div></div>

  <!-- MODAL: USER -->
  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0"><div class="modal-header"><h5 class="fw-bold" id="userModalTitle">Data Guru</h5></div><div class="modal-body"><form id="formUser"><input type="hidden" id="uMode" value="ADD"><input type="hidden" id="uOldPin"><label class="small text-muted fw-bold">Nama</label><input type="text" id="uInputName" class="form-control mb-2"><label class="small text-muted fw-bold">Sekolah</label><input type="text" id="uInputSchool" class="form-control mb-2"><div class="row g-2"><div class="col-6"><label class="small text-muted fw-bold">PIN</label><input type="text" id="uInputPin" class="form-control"></div><div class="col-6"><label class="small text-muted fw-bold">Role</label><select id="uInputRole" class="form-select"><option value="GURU">GURU</option><option value="ADMIN">ADMIN</option></select></div></div></form></div><div class="modal-footer"><button onclick="saveUser()" class="btn btn-primary w-100 rounded-pill">Simpan Data</button></div></div></div></div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxCTYyM2VjFQzfLKKIcYevkivH4TerMrU7jYakvJxR75_yXULW_YmKFy7nYrdBhnOAq/exec";
    
    let APP = {
       data: [], filtered: [], users: [], settings: [],
       user: { name: "Tamu", role: "GUEST", school: "-" },
       page: 1, perPage: 15, activeTab: 'ALL', favorites: new Set(),
       currentDetailId: null
    };

    window.onload = () => {
       const saved = localStorage.getItem('gb_user'); if(saved) APP.user = JSON.parse(saved);
       const favs = localStorage.getItem('gb_favorites'); if(favs) APP.favorites = new Set(JSON.parse(favs));
       updateUI(); fetchData();
    };

    async function api(action, payload=null) {
       if(action==='read'){ const c=localStorage.getItem('gb_cache'); if(c){const j=JSON.parse(c);if(Date.now()-j.ts<300000)return j.data;} }
       if(['simpan','hapus','updateKurasi','simpanUser','hapusUser'].includes(action)) localStorage.removeItem('gb_cache');
       try {
         let url=API_URL; let opts={};
         if(action==='read') url+="?action=read"; else opts={method:"POST",body:JSON.stringify({action,payload})};
         const req=await fetch(url,opts); const res=await req.json();
         if(action==='read'&&res.status==='success') localStorage.setItem('gb_cache',JSON.stringify({ts:Date.now(),data:res}));
         return res;
       } catch(e) { console.error(e); return {status:'error',message:e.toString()}; }
    }

    function fetchData() {
       document.getElementById('loader').classList.remove('d-none');
       api('read').then(res => {
          document.getElementById('loader').classList.add('d-none');
          if(res.status === 'success') {
             APP.data = res.media; APP.settings = res.settings;
             populateSelects(); applyFilters(); updateStats();
          }
       });
    }

    /* --- UI LOGIC --- */
    function updateUI() {
       const isGuest = APP.user.role === 'GUEST'; 
       const isAdmin = ['ADMIN','MODERATOR'].includes(APP.user.role);
       const isSuperAdmin = APP.user.role === 'ADMIN';

       document.getElementById('guestPanel').classList.toggle('d-none', !isGuest);
       document.getElementById('userPanel').classList.toggle('d-none', isGuest);
       document.getElementById('fabAdd').classList.toggle('d-none', isGuest);
       
       if(!isGuest) {
          document.getElementById('uName').innerText = APP.user.name; document.getElementById('uAvatar').innerText = APP.user.name.charAt(0);
          document.getElementById('uRole').innerText = APP.user.role; document.getElementById('menuDashboard').classList.toggle('d-none', !isAdmin);
          document.getElementById('admRoleBadge').innerText = APP.user.role;
       }
       
       // Sembunyikan Tab Guru (Manajemen User) jika bukan ADMIN (Moderator tidak boleh)
       document.getElementById('tabLinkUsers').classList.toggle('d-none', !isSuperAdmin);
    }

    function switchView(viewName) {
       document.getElementById('view-galeri').classList.toggle('d-none', viewName !== 'GALERI');
       document.getElementById('view-admin').classList.toggle('d-none', viewName !== 'ADMIN');
       document.getElementById('fabAdd').classList.toggle('d-none', viewName === 'ADMIN' || APP.user.role === 'GUEST');
    }
    
    function switchTab(tab) {
        APP.activeTab = tab;
        document.querySelectorAll('.nav-pills-custom .nav-link').forEach(el => el.classList.remove('active'));
        if(tab === 'ALL') document.getElementById('tab-all').classList.add('active');
        if(tab === 'MINE') document.getElementById('tab-mine').classList.add('active');
        if(tab === 'FAV') document.getElementById('tab-fav').classList.add('active');
        applyFilters();
    }

    function toggleFavorite(e, id) {
        e.stopPropagation();
        if(APP.favorites.has(id)) APP.favorites.delete(id); else APP.favorites.add(id);
        localStorage.setItem('gb_favorites', JSON.stringify([...APP.favorites]));
        if(APP.activeTab === 'FAV') applyFilters(); else { e.currentTarget.classList.toggle('is-fav'); }
    }
    function toggleSearch() { document.getElementById('searchBar').classList.toggle('d-none'); document.getElementById('searchInput').focus(); }
    function hideMenu() { bootstrap.Offcanvas.getInstance(document.getElementById('menuOffcanvas'))?.hide(); }

    /* --- RENDER LIST --- */
    function renderList() {
       const container = document.getElementById('list-container');
       if(APP.page === 1) container.innerHTML = '';
       const sliced = APP.filtered.slice(0, APP.page * APP.perPage);
       
       if(sliced.length === 0) {
          container.innerHTML = `<div class="text-center text-muted py-5"><i class="fas fa-box-open fa-3x mb-3 opacity-25"></i><br>Tidak ada karya.</div>`;
          document.getElementById('btnLoadMore').classList.add('d-none'); return;
       }

       let html = '';
       sliced.forEach(item => {
          const id=item[13], title=item[5]||"Tanpa Judul", guru=item[1]||"Anonim", mapel=item[6]||"-", jenis=item[11]||"Media", status=item[9];
          const isMy=APP.user.name===guru, isApproved=status==='DISETUJUI', isFav=APP.favorites.has(id);
          
          // SEMUA KARYA DITAMPILKAN (Filter status dihapus sesuai permintaan)

          let icon="fa-file", color="#94a3b8";
          if(jenis.includes("Video")) { icon="fa-play"; color="#ef4444"; } else if(jenis.includes("Modul")) { icon="fa-book"; color="#0f766e"; } else if(jenis.includes("Game")) { icon="fa-gamepad"; color="#8b5cf6"; }
          
          let thumbHtml = `<div class="m-thumb" style="background:${color}"><i class="fas ${icon}"></i></div>`;
          const ytId = getYoutubeId(item[8]); if(ytId) thumbHtml = `<div class="m-thumb"><img src="https://img.youtube.com/vi/${ytId}/mqdefault.jpg"></div>`;

          let statusBadge = '';
          // BADGE LOGIC: Tampilkan Centang Biru untuk semua yang APPROVED
          if (status === 'DISETUJUI') {
               statusBadge = `<span class="m-status st-ok"><i class="fas fa-check-circle me-1"></i>TAYANG</span>`;
          } 
          // Untuk status lain (PENDING/REVISI), HANYA tampilkan ke Pemilik atau Admin
          else if (isMy || APP.user.role !== 'GUEST') {
             if(status === 'BARU') statusBadge = `<span class="m-status st-baru">MENUNGGU</span>`;
             else if(status === 'REVISI') statusBadge = `<span class="m-status st-rev">REVISI</span>`;
          }

          html += `
          <div class="m-card" onclick="showDetail('${id}')">
             <button class="btn-fav ${isFav?'is-fav':''}" onclick="toggleFavorite(event, '${id}')"><i class="${isFav?'fas':'far'} fa-heart"></i></button>
             ${thumbHtml}
             <div class="m-content"><div class="m-title">${title}</div><div class="m-meta"><i class="fas fa-user-circle me-1"></i> ${guru}</div><span class="m-badge badge-mapel">${mapel}</span> <span class="m-badge bg-light text-secondary border">${jenis}</span></div>${statusBadge}
          </div>`;
       });
       container.innerHTML = html;
       document.getElementById('btnLoadMore').classList.toggle('d-none', APP.filtered.length <= sliced.length);
    }
    
    function loadMore() { APP.page++; renderList(); }
    
    function handleSearch(val) {
       const q = val.toLowerCase(); const fMapel = document.getElementById('filterMapel').value; const fFase = document.getElementById('filterFase').value;
       APP.filtered = APP.data.filter(i => {
          const str = (i[1]+' '+i[5]+' '+i[6]).toLowerCase();
          const matchSearch = str.includes(q); const matchMapel = fMapel ? i[6] === fMapel : true; const matchFase = fFase ? i[3] === fFase : true;
          let matchTab = true;
          if(APP.activeTab === 'MINE') { if(APP.user.role === 'GUEST') matchTab = false; else matchTab = (i[1] === APP.user.name); } 
          else if(APP.activeTab === 'FAV') { matchTab = APP.favorites.has(i[13]); }
          // VISIBLE Logic: Show All
          return matchSearch && matchMapel && matchFase && matchTab;
       });
       APP.page = 1; renderList();
    }
    function applyFilters() { handleSearch(document.getElementById('searchInput').value); }

    /* --- ITEM DETAILS & PREVIEW --- */
    function showDetail(id) {
       APP.currentDetailId = id;
       const item = APP.data.find(i => i[13] === id); if(!item) return;
       document.getElementById('detTitle').innerText = item[5]; document.getElementById('detGuru').innerText = "Oleh: " + item[1] + " ("+item[2]+")";
       
       const isMy = APP.user.name === item[1]; const isAdmin = ['ADMIN','MODERATOR'].includes(APP.user.role);
       const divAction = document.getElementById('ownerActions');
       divAction.classList.toggle('d-none', !(isMy || isAdmin));
       if(isMy || isAdmin) {
          document.getElementById('btnEdit').onclick = () => { bootstrap.Modal.getInstance(document.getElementById('modalDetail')).hide(); editItem(id); };
          document.getElementById('btnDelete').onclick = () => { deleteItem(id); };
       }
       new bootstrap.Modal(document.getElementById('modalDetail')).show();
    }

    function openFullscreenPreview() {
        if(!APP.currentDetailId) return;
        const item = APP.data.find(i => i[13] === APP.currentDetailId);
        bootstrap.Modal.getInstance(document.getElementById('modalDetail')).hide();
        
        // Cek jika Storybook/External Link
        const link = item[8] || "";
        if((item[11] && item[11].toUpperCase().includes('STORY')) || link.includes('gemini') || link.includes('g.co')) {
            window.open(link, '_blank'); return;
        }

        // Buka Overlay
        const overlay = document.getElementById('previewOverlay');
        const frame = document.getElementById('previewFrame');
        document.getElementById('previewTitle').innerText = item[5];
        overlay.style.display = 'flex';
        
        let src = link;
        const ytId = getYoutubeId(link);
        const rawHtml = item[7];

        if(rawHtml && rawHtml.length > 5) {
             const blob = new Blob([rawHtml], { type: 'text/html' });
             frame.src = URL.createObjectURL(blob);
             frame.dataset.blob = frame.src;
        } else if(ytId) {
             frame.src = `https://www.youtube.com/embed/${ytId}?autoplay=1`;
        } else if(link.includes('drive.google.com')) {
             frame.src = link.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview');
        } else {
             frame.src = link;
        }
    }
    
    function tutupPreview() {
        const overlay = document.getElementById('previewOverlay');
        overlay.style.display = 'none';
        const frame = document.getElementById('previewFrame');
        frame.src = "";
        if(frame.dataset.blob) { URL.revokeObjectURL(frame.dataset.blob); frame.dataset.blob = ""; }
    }

    /* --- CRUD INPUT FORM --- */
    function openInputModal() {
       document.getElementById('formInput').reset(); document.getElementById('formMode').value = "ADD";
       document.getElementById('dispNama').innerText = APP.user.name; document.getElementById('dispSekolah').innerText = APP.user.school;
       document.getElementById('feedbackAlert').classList.add('d-none');
       toggleInputSource('LINK');
       new bootstrap.Modal(document.getElementById('modalInput')).show();
    }
    
    function editItem(id) {
       const item = APP.data.find(i => i[13] === id);
       document.getElementById('formMode').value = "EDIT"; document.getElementById('editId').value = id;
       document.getElementById('dispNama').innerText = item[1]; document.getElementById('dispSekolah').innerText = item[2];
       
       document.getElementById('inJudul').value = item[5];
       document.getElementById('inFase').value = item[3]; document.getElementById('inSem').value = item[4];
       // Deskripsi field removed

       setValOrOther('inMapel', item[6], 'manMapel');
       setValOrOther('inJenis', item[11], 'manJenis');
       
       const link = item[8] || ""; const html = item[7] || "";
       if(html.length > 10 && html.includes('<')) {
           document.getElementById('inputSourceType').value = 'HTML'; toggleInputSource('HTML');
           document.getElementById('inHtml').value = html;
       } else if(link.includes('story') || link.includes('gemini') || link.includes('g.co')) {
           document.getElementById('inputSourceType').value = 'STORY'; toggleInputSource('STORY');
           document.getElementById('inLinkStory').value = link;
       } else {
           document.getElementById('inputSourceType').value = 'LINK'; toggleInputSource('LINK');
           document.getElementById('inLink').value = link;
       }

       const isKaih = !!item[10];
       document.getElementById('checkKaih').checked = isKaih; document.getElementById('inKaih').classList.toggle('d-none', !isKaih);
       if(isKaih) document.getElementById('inKaih').value = item[10];

       // Feedback logic
       if(item[12] && item[12].trim().length > 0) {
           document.getElementById('feedbackAlert').classList.remove('d-none');
           document.getElementById('feedbackMsg').innerText = item[12];
       } else {
           document.getElementById('feedbackAlert').classList.add('d-none');
       }

       updateLivePreview();
       new bootstrap.Modal(document.getElementById('modalInput')).show();
    }
    
    function toggleInputSource(type) {
        ['groupLink','groupStory','groupHtml'].forEach(id => document.getElementById(id).classList.add('d-none'));
        if(type === 'LINK') document.getElementById('groupLink').classList.remove('d-none');
        else if (type === 'STORY') document.getElementById('groupStory').classList.remove('d-none');
        else if (type === 'HTML') document.getElementById('groupHtml').classList.remove('d-none');
        updateLivePreview();
    }

    function updateLivePreview() {
        const type = document.getElementById('inputSourceType').value;
        let val = "";
        if(type==='LINK') val = document.getElementById('inLink').value;
        else if(type==='STORY') val = document.getElementById('inLinkStory').value;
        else if(type==='HTML') val = document.getElementById('inHtml').value;
        
        const frame = document.getElementById('miniPreviewFrame');
        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open();
        
        const style = `<style>body{margin:0;padding:10px;font-family:sans-serif;color:#555;text-align:center;font-size:0.8rem} img{max-width:100%}</style>`;
        
        if(type === 'STORY') doc.write(style + "ðŸ“– Preview Storybook tersedia setelah disimpan.");
        else if (type==='HTML' && val.length > 5) doc.write(val);
        else if (val.length > 5) {
            const ytId = getYoutubeId(val);
            if(ytId) doc.write(`<iframe src="https://www.youtube.com/embed/${ytId}" style="width:100%;aspect-ratio:16/9;border:none"></iframe>`);
            else doc.write(style + `<div style="padding-top:40px">ðŸ”— Preview Website</div>`);
        } else {
            doc.write(style + `<div style="padding-top:60px">Preview Konten</div>`);
        }
        doc.close();
    }

    function checkDropdown(selId, manId, val) {
        const man = document.getElementById(manId);
        if(!man) return;
        if(val === 'LAINNYA') { man.classList.remove('d-none'); man.focus(); } else { man.classList.add('d-none'); man.value = ""; }
    }
    function setValOrOther(elId, val, manId) {
        const el = document.getElementById(elId);
        if(Array.from(el.options).some(o => o.value === val)) { el.value = val; checkDropdown(elId, manId, val); }
        else { el.value = 'LAINNYA'; checkDropdown(elId, manId, 'LAINNYA'); document.getElementById(manId).value = val; }
    }

    function saveData() {
       const title = document.getElementById('inJudul').value.trim();
       let mapel = document.getElementById('inMapel').value; if(mapel==='LAINNYA') mapel = document.getElementById('manMapel').value;
       let jenis = document.getElementById('inJenis').value; if(jenis==='LAINNYA') jenis = document.getElementById('manJenis').value;
       const fase = document.getElementById('inFase').value;
       
       // Tentukan Link Akhir
       const type = document.getElementById('inputSourceType').value;
       let finalLink = ""; let finalHtml = "";
       if(type === 'STORY') finalLink = document.getElementById('inLinkStory').value;
       else if(type === 'HTML') finalHtml = document.getElementById('inHtml').value;
       else finalLink = document.getElementById('inLink').value;

       if(!title || !mapel || !jenis || !fase || (!finalLink && !finalHtml)) {
           return Swal.fire('Data Belum Lengkap','Isi kolom wajib dan link/konten karya.','warning');
       }

       const payload = {
          nama: APP.user.name, sekolah: APP.user.school, judul: title,
          mapel: mapel, jenis: jenis, fase: fase, semester: document.getElementById('inSem').value,
          linkLuar: finalLink, kodeHtml: finalHtml, 
          kaihType: document.getElementById('checkKaih').checked ? document.getElementById('inKaih').value : "",
          mode: document.getElementById('formMode').value, idUnik: document.getElementById('editId').value
       };
       
       Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
       api('simpan', payload).then(res => {
          if(res.status === 'success') {
             Swal.fire('Berhasil', 'Tersimpan', 'success'); bootstrap.Modal.getInstance(document.getElementById('modalInput')).hide(); fetchData();
          } else { Swal.fire('Gagal', res.message, 'error'); }
       });
    }

    /* --- ADMIN & RANKING LOGIC --- */
    function updateStats() {
       document.getElementById('statTotal').innerText = APP.data.length;
       document.getElementById('statPending').innerText = APP.data.filter(i => i[9] === 'BARU').length;
       document.getElementById('statApproved').innerText = APP.data.filter(i => i[9] === 'DISETUJUI').length;
    }
    
    function loadSchoolStats() {
       if(!APP.users.length) api('users').then(res => { APP.users = res.data; calcSchool(); }); else calcSchool();
    }
    function calcSchool() {
        let stats = {}, total = APP.data.length;
        APP.users.forEach(u => { let s=u[1]||"Tanpa Sekolah"; if(!stats[s]) stats[s]={g:0,k:0}; stats[s].g++; });
        APP.data.forEach(m => { let s=m[2]||"Tanpa Sekolah"; if(!stats[s]) stats[s]={g:0,k:0}; stats[s].k++; });
        
        let arr = Object.keys(stats).map(k => ({n:k, g:stats[k].g, k:stats[k].k})).sort((a,b) => b.k - a.k);
        let h = '<table class="table table-sm table-striped"><thead><tr><th>#</th><th>Sekolah</th><th class="text-center">Guru</th><th class="text-center">Karya</th></tr></thead><tbody>';
        arr.forEach((x,i) => {
            let rank = i<3 ? `<span class="rank-badge rank-${i+1}">${i+1}</span>` : `<span class="rank-badge rank-other">${i+1}</span>`;
            h += `<tr><td>${rank}</td><td>${x.n}</td><td class="text-center">${x.g}</td><td class="text-center fw-bold">${x.k}</td></tr>`;
        });
        document.getElementById('school-rank-container').innerHTML = h + '</tbody></table>';
    }

    function loadTeacherStats() {
        let counts = {};
        APP.data.forEach(m => { let n=m[1]; if(!counts[n]) counts[n]={n:n,s:m[2],c:0}; counts[n].c++; });
        let arr = Object.values(counts).sort((a,b) => b.c - a.c).slice(0,50);
        let h = '<table class="table table-sm table-striped"><thead><tr><th>#</th><th>Guru</th><th class="text-center">Karya</th></tr></thead><tbody>';
        arr.forEach((x,i) => {
            let rank = i<3 ? `<span class="rank-badge rank-${i+1}">${i+1}</span>` : `<span class="rank-badge rank-other">${i+1}</span>`;
            h += `<tr><td>${rank}</td><td><div class="fw-bold">${x.n}</div><small class="text-muted">${x.s}</small></td><td class="text-center fw-bold text-primary">${x.c}</td></tr>`;
        });
        document.getElementById('teacher-rank-container').innerHTML = h + '</tbody></table>';
    }

    /* --- HELPERS --- */
    function deleteItem(id) { Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true}).then(r => { if(r.isConfirmed) { bootstrap.Modal.getInstance(document.getElementById('modalDetail')).hide(); api('hapus', {id}).then(() => { Swal.fire('Terhapus','','success'); fetchData(); }); }}); }
    function adminFilter() {
       const q = document.getElementById('searchAdmKarya').value.toLowerCase(); const fStat = document.getElementById('admFilterStatus').value; const fMapel = document.getElementById('admFilterMapel').value;
       const list = APP.data.filter(i => (i[5]+' '+i[1]).toLowerCase().includes(q) && (fStat?i[9]===fStat:true) && (fMapel?i[6]===fMapel:true));
       let html = '';
       list.forEach(i => {
           let badge = i[9]==='DISETUJUI'?'bg-success':(i[9]==='REVISI'?'bg-danger':'bg-warning text-dark');
           html += `<div class="m-card flex-column align-items-stretch"><div class="d-flex justify-content-between"><div class="fw-bold text-truncate">${i[5]}</div><span class="badge ${badge}">${i[9]}</span></div><div class="small text-muted">${i[1]}</div><div class="d-flex gap-2 mt-2"><button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="openKurasi('${i[13]}','${i[9]}')">Kurasi</button><button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${i[13]}')"><i class="fas fa-trash"></i></button></div></div>`;
       });
       document.getElementById('admin-list-container').innerHTML = html;
    }
    
    function openKurasi(id, st) { const item=APP.data.find(i=>i[13]===id); document.getElementById('kurId').value=id; document.getElementById('kurStatus').value=st; document.getElementById('kurNote').value=item[12]||""; new bootstrap.Modal(document.getElementById('modalKurasi')).show(); }
    function saveKurasi() { api('updateKurasi', {id:document.getElementById('kurId').value, status:document.getElementById('kurStatus').value, feedback:document.getElementById('kurNote').value}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalKurasi')).hide(); Swal.fire('Updated','','success'); fetchData(); }); }
    
    function loadUserList(q='') { if(!APP.users.length) api('users').then(res=>{APP.users=res.data; renderUsers(q)}); else renderUsers(q); }
    function renderUsers(q='') {
       const list = APP.users.filter(u => (u[0]+' '+u[1]).toLowerCase().includes(q.toLowerCase()));
       let html = '';
       list.forEach((u, idx) => { html += `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div><div class="fw-bold">${u[0]}</div><div class="small text-muted">${u[1]} (${u[3]})</div><div class="small text-primary font-monospace">PIN: ${u[2]}</div></div><div class="d-flex gap-2"><button class="btn btn-sm btn-light border text-warning" onclick="showUserModal('EDIT', ${idx})"><i class="fas fa-pen"></i></button><button class="btn btn-sm btn-light border text-danger" onclick="deleteUser('${u[2]}', '${u[0]}')"><i class="fas fa-trash"></i></button></div></div>`; });
       document.getElementById('user-list-container').innerHTML = html;
       document.getElementById('statUsers').innerText = APP.users.length;
    }
    function showUserModal(mode, idx=null) { document.getElementById('formUser').reset(); document.getElementById('uMode').value = mode; if(mode === 'EDIT'){ const u=APP.users[idx]; document.getElementById('uInputName').value=u[0]; document.getElementById('uInputSchool').value=u[1]; document.getElementById('uInputPin').value=u[2]; document.getElementById('uOldPin').value=u[2]; document.getElementById('uInputRole').value=u[3]; } new bootstrap.Modal(document.getElementById('modalUser')).show(); }
    function saveUser() { api('simpanUser', {nama:document.getElementById('uInputName').value, sekolah:document.getElementById('uInputSchool').value, pin:document.getElementById('uInputPin').value, role:document.getElementById('uInputRole').value, mode:document.getElementById('uMode').value, oldPin:document.getElementById('uOldPin').value}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalUser')).hide(); APP.users=[]; loadUserList(); Swal.fire('Success','','success'); }); }
    function deleteUser(pin, name) { Swal.fire({title:`Hapus ${name}?`,icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed) api('hapusUser',{pin}).then(()=>{APP.users=[]; loadUserList();});}); }

    function downloadExcel() {
        if(!APP.data.length) return Swal.fire('Data Kosong','','warning');
        let csv = "Timestamp,Nama,Sekolah,Fase,Semester,Judul,Mapel,Deskripsi,Link,Status,KAIH,Jenis,Catatan\n" + APP.data.map(r => r.slice(0,13).map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
        const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "data_karya.csv"; link.click();
    }
    document.getElementById('checkKaih').onchange = (e) => { document.getElementById('inKaih').classList.toggle('d-none', !e.target.checked); };
    function populateSelects() {
       const setOptions = (id, idx, oth) => { const el = document.getElementById(id); el.innerHTML='<option value="">Pilih</option>'; APP.settings.forEach(r => {if(r[idx])el.innerHTML+=`<option value="${r[idx]}">${r[idx]}</option>`}); if(oth)el.innerHTML+='<option value="LAINNYA">LAINNYA</option>'; };
       setOptions('inJenis',0,true); setOptions('inMapel',1,true); setOptions('admFilterMapel',1); setOptions('filterMapel',1); setOptions('inFase',2); setOptions('filterFase',2); setOptions('inKaih',3); setOptions('inSem',4);
    }
    function getYoutubeId(url) { if(!url) return false; const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (m && m[2].length == 11) ? m[2] : false; }
    function loginModal() { document.getElementById('loginPin').value = ''; new bootstrap.Modal(document.getElementById('modalLogin')).show(); }
    function submitLogin(e) { e.preventDefault(); api('login', {pin: document.getElementById('loginPin').value}).then(res => { if(res.status==='success') { APP.user=res.user; localStorage.setItem('gb_user',JSON.stringify(res.user)); Swal.fire('Login Berhasil','','success').then(()=>location.reload()); } else Swal.fire('Gagal',res.message,'error'); }); }
    function logout() { localStorage.removeItem('gb_user'); location.reload(); }
  </script>
</body>
</html>
